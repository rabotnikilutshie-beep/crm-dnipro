<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<title>CRM Dnepr</title>
<style>
    /* Dark Theme Core */
    body { margin:0; padding:15px; background: radial-gradient(1200px 800px at 20% 10%, #1b2a3a 0%, rgba(27,42,58,0) 60%), radial-gradient(900px 600px at 80% 0%, #2a1b3a 0%, rgba(42,27,58,0) 55%), linear-gradient(135deg, #0b0f14 0%, #0e1117 40%, #070a0f 100%); color:#e6e6e6; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; min-height:100vh; }

    body:before { content:""; position:fixed; inset:0; pointer-events:none; background: radial-gradient(900px 500px at 50% -10%, rgba(255,255,255,0.06), rgba(255,255,255,0) 60%); mix-blend-mode: screen; opacity:.45; }

    
    /* Layout */
    .card { background: rgba(22,27,34,0.92); backdrop-filter: blur(6px); padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid #30363d; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
    .layout { display:grid; grid-template-columns: 1fr 400px; gap:15px; }
    .hidden { display: none !important; }
    
    /* Inputs & Textareas */
    input, select, textarea { background:#0d1117; border:1px solid #30363d; color:#fff; padding:8px; border-radius:6px; width:100%; box-sizing: border-box; margin-bottom:5px; }
    textarea { height: 350px; resize: vertical; }

    /* Buttons */
    button { cursor:pointer; background:#238636; color:#fff; border:none; border-radius:6px; padding:8px 14px; font-weight:600; transition:0.2s; margin-right:5px; margin-bottom:5px; }
    button:hover { opacity: 0.9; }
    .btn-red { background: #da3633; }
    .btn-yel { background: #d29922; color: #000; }
    .btn-blue { background: #2f81f7; }
    .btn-pur { background: #8957e5; }
    .btn-gray { background: #21262d; border: 1px solid #30363d; }
    
    /* Status Badges & Items */
    .order-item { background: rgba(33,38,45,0.92); padding: 18px; border-radius: 12px; margin-bottom: 12px; border-left: 6px solid #238636; position: relative; min-height: 170px; }
    .order-item.return { border-left-color: #da3633; }
    .order-item.kupat { border-left-color: #d29922; }
    .order-grid { display:grid; grid-template-columns: 1fr; gap:10px; }
    .order-head { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
    .order-title { font-size:18px; font-weight:800; letter-spacing:0.2px; }
    .order-phone { font-size:16px; font-weight:700; color:#9ecbff; }
    .pillbar { display:flex; flex-wrap:wrap; gap:8px; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:13px; font-weight:800; border:1px solid #30363d; background:#161b22; }
    .pill small { font-size:11px; font-weight:700; color:#8b949e; }
    .pill .who { color:#e6e6e6; }
    .comment-box { background:#0d1117; border:1px solid #30363d; border-radius:10px; padding:10px; }
    .comment-box textarea { height: 84px; margin:0; }
    .comment-list { display:flex; flex-direction:column; gap:8px; }
    .comment { border:1px solid rgba(255,255,255,0.08); background:rgba(13,17,23,0.65); padding:8px 10px; border-radius:10px; }
    .comment .meta { font-size:11px; color:#8b949e; margin-bottom:4px; }
    .comment .txt { white-space:pre-wrap; font-size:13px; }
    .kvcol { display:grid; grid-template-columns: 120px 1fr; gap:10px; }
    .kvcol .k { color:#8b949e; font-size:12px; }
    .kvcol .v { font-size:13px; white-space:pre-wrap; }
    .badge { display:inline-block; padding:2px 6px; border-radius:4px; font-size:11px; font-weight:bold; background:#30363d; }
    
    /* Tables */
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { border: 1px solid #30363d; padding: 8px; text-align: left; }
    tr:nth-child(even) { background: #161b22; }
    .right { text-align: right; }
    .tableWrap { width:100%; overflow:auto; border-radius:12px; border:1px solid #30363d; }
    .tbl { min-width: 980px; }
    
    /* Call Action Grid */
    .action-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
    .sip-btn { display:block; background:#2f81f7; color:white; text-align:center; padding:15px; border-radius:8px; text-decoration:none; font-weight:bold; font-size:18px; margin-bottom:15px; }

    /* Income calculator helpers */
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:14px; }
    @media (max-width: 980px){ .grid2{ grid-template-columns:1fr; } }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0; }
    .row label { color:#c9d1d9; font-size:13px; min-width:160px; }
    .row input { width: 220px; max-width: 100%; }
    .kv { display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.06); }
    .kv:last-child { border-bottom:0; }

    .sheet-embed-wrap{ margin-top:16px; }
    .sheet-embed-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px; flex-wrap:wrap; }
    .sheet-embed-frame{ width:100%; min-height:640px; border:1px solid #30363d; border-radius:12px; background:#0d1117; }

    .muted{ color: rgba(230,230,230,0.7); }
    .bigNum{ font-size:28px; font-weight:800; }

.modal.hidden{display:none !important;}
.modal{position:fixed; inset:0; z-index:9999;}
.modal-backdrop{position:absolute; inset:0; background:rgba(0,0,0,0.55); backdrop-filter: blur(2px);}
.modal-card{position:relative; max-width:520px; margin:8vh auto; background:rgba(13,17,23,0.96); border:1px solid #30363d; border-radius:16px; padding:14px; box-shadow: 0 20px 60px rgba(0,0,0,0.55);}
.btn-vio{background:linear-gradient(135deg,#7c3aed,#a855f7); color:#fff; font-weight:900;}
.btn-vio:hover{filter:brightness(1.05);}

.auth-shell{max-width:360px; margin:220px auto 0; display:flex; flex-direction:column; align-items:center; gap:16px;}
.auth-gif-wrap{width:100%; display:flex; justify-content:center;}
.auth-gif{width:240px; max-width:100%; border-radius:12px; border:1px solid #30363d; box-shadow:0 10px 30px rgba(0,0,0,.45); object-fit:cover; background:#000;}
#auth-box{max-width:320px; width:100%; margin:0 auto; text-align:center;}
@media (max-height: 900px){ .auth-shell{ margin-top:140px; } }
@media (max-width: 560px){ .auth-shell{ margin-top:90px; } .auth-gif{ width:200px; } }
</style>
</head>
<body>
<div class="auth-shell" id="auth-shell">
<div class="auth-gif-wrap">
<img alt="–û–∂–∏–¥–∞–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏" class="auth-gif" src="https://reibert.info/media/gifki-gitler-chaj-163126-gif.394052/full?d=1457731364"/>
</div>
<div class="card" id="auth-box">
<h2>CRM Dnipro</h2>
<input id="logIn" placeholder="–õ–æ–≥–∏–Ω" type="text"/>
<input id="pasIn" placeholder="–ü–∞—Ä–æ–ª—å" type="password"/>
<button id="btnLogin" style="width:100%; margin-top:10px">–í–û–ô–¢–ò</button>
<div id="loginMsg" style="margin-top:10px; font-size:13px; color:#ffb3b3; display:none"></div>
</div>
</div>
<div class="hidden" id="main-ui">
<div class="card" style="display:flex; justify-content:space-between; align-items:center;">
<div>üë§ <b id="uLabel"></b> <span class="badge" id="rLabel"></span> <span id="soundHint" style="font-size:11px; color:#8b949e; margin-left:8px"></span></div>
<div id="nav-buttons">
</div>
</div>
<div class="hidden layout" id="tab-work">
<div class="card" style="text-align:center">
<div id="client-area" style="margin-top:50px;">
<button class="btn-blue" onclick="nextClient()" style="padding:15px 30px; font-size:18px;">–ù–ê–ß–ê–¢–¨ –û–ë–ó–í–û–ù</button>
</div>
</div>
<div class="card">
<textarea id="note" placeholder="–ó–∞–º–µ—Ç–∫–∞ –∫ –∑–≤–æ–Ω–∫—É..."></textarea>
</div>
</div>
<div class="hidden card" id="tab-create-order">
    <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h2>
    <div class="panel">
      <div class="row">
        <div class="col">
          <label>–ò–º—è</label>
          <input id="co-name" class="input" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞">
        </div>
        <div class="col">
          <label>–ù–æ–º–µ—Ä</label>
          <input id="co-phone" class="input" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
        </div>
      </div>
      <div class="row">
        <div class="col">
          <label>–¢–ó</label>
          <input id="co-tz" class="input" placeholder="–¢–ó">
        </div>
        <div class="col">
          <label>–ê–¥—Ä–µ—Å</label>
          <input id="co-address" class="input" placeholder="–ê–¥—Ä–µ—Å">
        </div>
        <div class="col">
          <label>–í–æ–∑—Ä–∞—Å—Ç</label>
          <input id="co-age" class="input" placeholder="–í–æ–∑—Ä–∞—Å—Ç">
        </div>
      </div>
      <label>–î–æ–ø. –∏–Ω—Ñ–∞</label>
      <textarea id="co-extra" class="textarea" placeholder="–î–æ–ø. –∏–Ω—Ñ–∞"></textarea>

      <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
        <button class="btn-purple" onclick="createOrderToTech()">–ü–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ —Ç–µ—Ö–Ω–∏–∫–∞</button>
        <span id="co-status" class="muted"></span>
      </div>
      <div class="muted" style="margin-top:8px;">*–î–æ—Å—Ç—É–ø–Ω–æ –≤—Å–µ–º, –∫—Ä–æ–º–µ —Ä–æ–ª–∏ –ö—É–ø–∞—Ç. –ó–∞—è–≤–∫–∞ —Å—Ä–∞–∑—É –ø–æ–ø–∞–¥—ë—Ç —Ç–µ—Ö–Ω–∏–∫—É.</div>
    </div>
  </div>

<div class="hidden card" id="tab-notes">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
    <h3 style="margin:0">üìù –ó–∞–º–µ—Ç–∫–∏</h3>
    <button class="btn-pur" onclick="openNotesModal({source:'manual'}, '–ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞')">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
  </div>
  <div id="notes-list" style="margin-top:10px"></div>
</div>

<div class="hidden card" id="tab-callbacks"><h3>üîÅ –ü–µ—Ä–µ–∑–≤–æ–Ω</h3><div id="list-callbacks"></div></div>
<div class="hidden card" id="tab-my-orders"><h3 id="my-title">üì§ –ò—Å—Ç–æ—Ä–∏—è</h3><div id="list-my"></div></div>
<div class="hidden card" id="tab-tech"><h3>üõ† –ó–∞—è–≤–∫–∏ (–¢–µ—Ö–Ω–∏–∫)</h3><div id="list-tech"></div></div>
<div class="hidden card" id="tab-tech-my"><h3>üß∞ –ú–æ–∏ —Ç–µ—Ö–Ω–∏–∫–∏</h3><div id="list-tech-my"></div></div>
<div class="hidden card" id="tab-returns"><h3>‚Ü© –í–æ–∑–≤—Ä–∞—Ç—ã / –ù–î–ó</h3><div id="list-returns"></div></div>
<div class="hidden card" id="tab-closer"><h3>üí∞ –ó–∞–∫—Ä—ã—Ç–∏–µ —Å–¥–µ–ª–æ–∫</h3><div id="list-closer"></div></div>
<div class="hidden card" id="tab-kupat"><h3>üë¥ –ë–∞–∑–∞ "–ù–∞ –ö—É–ø–∞—Ç"</h3><div id="list-kupat"></div></div>
<div class="hidden card" id="tab-kupat-my-clients"><h3>üë¥ –ú–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã (–ö—É–ø–∞—Ç)</h3><div id="list-kupat-my-clients"></div></div>
<div class="hidden card" id="tab-kupat-my-transfers"><h3>üì§ –ú–æ–∏ –ø–µ—Ä–µ–¥–∞—á–∏ (–ö—É–ø–∞—Ç)</h3><div id="list-kupat-my-transfers"></div></div>
<div class="hidden card" id="tab-income">
<h3>üíµ –î–æ—Ö–æ–¥</h3>
<div style="color:#8b949e; font-size:13px; margin-bottom:10px">
        –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞. –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∑–∞—Ä–ø–ª–∞—Ç—ã ‚Äî –ø–æ–∫–∞ –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.
    </div>
<div class="grid2">
<div class="card" style="padding:14px">
<div class="row"><label>–°—É–º–º–∞ –∑–∞–∫—Ä—ã–≤–∞</label><input id="inc_sum" placeholder="10000" step="0.01" type="number" value="10000"/></div>
<div class="row"><label>–ü—Ä–æ—Ü–µ–Ω—Ç –∫—É—Ä—ã (%)</label><input id="inc_kura" placeholder="14" step="0.01" type="number" value="14"/></div>
<div class="row"><label>% –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞</label><input id="inc_client_pct" placeholder="15" step="0.01" type="number" value="15"/></div>
<hr style="border:0;border-top:1px solid rgba(255,255,255,0.08); margin:12px 0"/>
<div class="row"><label>–†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞</label><input id="inc_div" placeholder="4" step="0.01" type="number" value="4"/></div>
<div class="row"><label>–£–º–Ω–æ–∂–∏—Ç—å –Ω–∞</label><input id="inc_mul" placeholder="36" step="0.01" type="number" value="36"/></div>
<div style="display:flex; gap:10px; margin-top:12px">
<button class="btn-gray" onclick="incomeReset()">–°–±—Ä–æ—Å</button>
</div>
</div>
<div class="card" style="padding:14px">
<div style="font-size:13px; color:#8b949e; margin-bottom:8px">–†–∞—Å—á—ë—Ç</div>
<div class="kv"><div>–ö—É—Ä–∞:</div><div id="inc_kura_sum">‚Äî</div></div>
<div class="kv"><div>–û—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ –∫—É—Ä—ã:</div><div id="inc_after_kura">‚Äî</div></div>
<div class="kv"><div>% –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞:</div><div id="inc_client_pct_out">‚Äî</div></div>
<div class="kv"><div>–°—É–º–º–∞ ‚Äú–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞‚Äù:</div><div id="inc_client_sum">‚Äî</div></div>
<hr style="border:0;border-top:1px solid rgba(255,255,255,0.08); margin:12px 0"/>
<div class="kv"><div>–ü–æ—Å–ª–µ –¥–µ–ª–µ–Ω–∏—è:</div><div id="inc_div_res">‚Äî</div></div>
<div class="kv"><div>–ò—Ç–æ–≥:</div><div id="inc_total" style="font-weight:800; font-size:20px">‚Äî</div></div>
<div style="margin-top:10px; font-size:12px; color:#8b949e">
                –§–æ—Ä–º—É–ª–∞: (–°—É–º–º–∞ ‚àí %–∫—É—Ä—ã) ‚Üí %–Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ ‚Üí /–¥–µ–ª–∏—Ç–µ–ª—å ‚Üí √ó–º–Ω–æ–∂–∏—Ç–µ–ª—å
            </div>
</div>
</div>

<div class="card sheet-embed-wrap" style="padding:14px">
<div class="sheet-embed-head">
<h3 style="margin:0">üìä Google-—Ç–∞–±–ª–∏—Ü–∞</h3>
<a class="btn-blue" href="https://docs.google.com/spreadsheets/d/1ai0mGxEYgTpfA5rdhDvM1R1Qk90gOYYh_kMBr_e3bZM/edit?gid=0#gid=0" rel="noopener noreferrer" style="text-decoration:none; display:inline-flex; align-items:center;" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ</a>
</div>
<div class="muted" style="font-size:12px; margin-bottom:8px">–ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –æ–∫–Ω–µ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Google –ø–æ iframe), –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ".</div>
<iframe allow="clipboard-read; clipboard-write" class="sheet-embed-frame" loading="lazy" src="https://docs.google.com/spreadsheets/d/1ai0mGxEYgTpfA5rdhDvM1R1Qk90gOYYh_kMBr_e3bZM/edit?gid=0&amp;single=true&amp;widget=true&amp;headers=false" title="Google —Ç–∞–±–ª–∏—Ü–∞ –¥–æ—Ö–æ–¥–æ–≤"></iframe>
</div>
</div>
<div class="hidden card" id="tab-logs"><h3>üìã –õ–æ–≥ –∑–≤–æ–Ω–∫–æ–≤</h3><table id="table-logs"><thead><tr><th>–í—Ä–µ–º—è</th><th>–û–ø–µ—Ä</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ò–Ω—Ñ–æ</th></tr></thead><tbody></tbody></table></div>
<div class="hidden" id="tab-admin">
<div class="layout">
<div class="card">
<h3>üë• –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h3>
<table id="table-stats"></table>

<hr style="border:0; border-top:1px solid #333; margin:14px 0"/>
<h3>üì§ –≠–∫—Å–ø–æ—Ä—Ç AUTO/–ù–î–ó</h3>
<div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
  <button class="btn-green" onclick="downloadAutoNdz()">–°–∫–∞—á–∞—Ç—å Excel AUTO/–ù–î–ó</button>
  <span class="muted">–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∫–∞–∫ <b>export_auto_ndz.xlsx</b></span>
</div>

<hr style="border:0; border-top:1px solid #333"/>
<div style="display:flex; gap:5px;">
<input id="nL" placeholder="–õ–æ–≥–∏–Ω" style="flex:1"/>
<input id="nP" placeholder="–ü–∞—Ä–æ–ª—å" style="flex:1"/>
<select id="nR" style="flex:1">
<option value="user">–û–ø–µ—Ä–∞—Ç–æ—Ä</option>
<option value="tech">–¢–µ—Ö–Ω–∏–∫</option>
<option value="closer">–ó–∞–∫—Ä—ã–≤</option>
<option value="kupat">–ö—É–ø–∞—Ç</option>
<option value="admin">–ê–¥–º–∏–Ω</option>
</select>
</div>
<button class="btn-blue" onclick="addUser()" style="width:100%; margin-top:5px;">–î–æ–±–∞–≤–∏—Ç—å</button>
<hr style="border:0; border-top:1px solid #333; margin:10px 0"/>
<h4 style="margin:0 0 6px 0">üí≥ –ë–∞–ª–∞–Ω—Å (—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω)</h4>
<div style="display:flex; gap:6px; align-items:center">
<select id="balUser" style="flex:1"></select>
<input id="balVal" placeholder="–ë–∞–ª–∞–Ω—Å" style="width:110px" type="number"/>
</div>
<button class="btn-gray" onclick="setBalance()" style="width:100%; margin-top:6px;">–ù–∞–∑–Ω–∞—á–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
</div>
<div class="card">
<h3>üóÑ –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö</h3>
<input id="fileIn" type="file"/>
<button class="btn-gray" onclick="uploadDb()">1. –ó–∞–≥—Ä—É–∑–∏—Ç—å Excel</button>
<hr style="border:0; border-top:1px solid #333; margin:10px 0"/>
<select id="dbSel"></select>
<button class="btn-blue" onclick="activateDb()">2. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É</button>
<div style="margin-top:8px; font-size:13px">
  <label style="display:flex; align-items:center; gap:8px; color:#c9d1d9">
    <input id="dbAllowDup" type="checkbox" style="width:auto; margin:0"/>
    –†–∞–∑—Ä–µ—à–∏—Ç—å –ø–æ–≤—Ç–æ—Ä—ã –¥–ª—è —ç—Ç–æ–π –±–∞–∑—ã (–∏–≥–Ω–æ—Ä –∞–Ω—Ç–∏-–¥—É–±–ª—è –ø–æ –∏—Å—Ç–æ—Ä–∏–∏)
  </label>
</div>
</div>
</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
let dbListCache = [];

async function downloadAutoNdz(){
  try{
    if(!me || me.role!=='admin'){ alert('–¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞'); return; }
    // –ø—Ä—è–º–æ–π download
    window.location.href = `/api/export/auto-ndz?login=${encodeURIComponent(me.login)}&role=${encodeURIComponent(me.role)}`;
  }catch(e){ console.error(e); }
}



</script>
<div id="tab-admin-stats" class="card hidden">
  <h3 style="margin:0 0 10px 0;">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
  <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
    <label style="font-size:13px;">–î–∞—Ç–∞:
      <input type="date" id="adminStatsDate" style="margin-left:8px;">
    </label>
    <button class="btn-green" id="adminStatsLoadBtn">‚ü≥ –ü–æ–∫–∞–∑–∞—Ç—å</button>
    <button class="btn-gray" id="adminStatsDownloadBtn">üì• –°–∫–∞—á–∞—Ç—å Excel</button>
	<button class="btn-yel" id="kupatExportBtn">üì¶ –°–∫–∞—á–∞—Ç—å –ö—É–ø–∞—Ç Excel</button>
    <span class="muted" style="font-size:12px;">–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω. –°—á–∏—Ç–∞–µ—Ç –∫–ª–∏–∫–∏ ‚Äú–ü–û–ó–í–û–ù–ò–¢–¨‚Äù –∏ –∫–Ω–æ–ø–∫–∏ (–ù–î–ó/–ê–í–¢–û/–û–¢–ö–ê–ó/–ò–í–†–ò–¢/–ü–ï–†–ï–î–ê–õ/–ù–ê –ö–£–ü–ê–¢).</span>
  </div>
  <div id="adminStatsBox" class="card" style="margin-top:12px; padding:12px; background:rgba(13,17,23,0.6); border:1px solid #30363d; min-height:160px;">
    –í—ã–±–µ—Ä–∏ –¥–∞—Ç—É –∏ –Ω–∞–∂–º–∏ ‚Äú–ü–æ–∫–∞–∑–∞—Ç—å‚Äù.
  </div>
</div>

<script>
// STATE
let me = null;
let curClient = null;

// --- STATS TRACKING (ADMIN REPORTS) ---
function trackEvent(action, phone='', extra='') {
  try {
    if (!me || !me.login) return;
    const payload = { login: me.login, role: me.role, action, phone, extra };
    const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
    if (navigator.sendBeacon) {
      navigator.sendBeacon('/api/stats/event', blob);
    } else {
      fetch('/api/stats/event', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload), keepalive: true });
    }
  } catch(e) {}
}

async function loadAdminStats() {
  if (!me || me.role !== 'admin') return;
  const dateInp = document.getElementById('adminStatsDate');
  const box = document.getElementById('adminStatsBox');
  if (!dateInp || !box) return;
  const day = (dateInp.value || '').slice(0,10);
  if (!day) { box.textContent = '–í—ã–±–µ—Ä–∏ –¥–∞—Ç—É.'; return; }
  box.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
  try {
    const r = await fetch(`/api/admin/stats?login=${encodeURIComponent(me.login)}&role=${encodeURIComponent(me.role)}&date=${encodeURIComponent(day)}`);
    const d = await r.json();
    if (!r.ok) { box.textContent = d.error || '–û—à–∏–±–∫–∞'; return; }
    const rows = d.rows || [];
    const th = ['–õ–æ–≥–∏–Ω','–ó–≤–æ–Ω–∫–æ–≤','–ù–î–ó','–ê–í–¢–û','–û–¢–ö–ê–ó','–ò–í–†–ò–¢','–ü–µ—Ä–µ–¥–∞–ª','–ö—É–ø–∞—Ç','–ó–∞–∫—Ä—ã–ª','–ü–µ—Ä–≤–æ–µ','–ü–æ—Å–ª–µ–¥–Ω–µ–µ'];
    let html = '<div style="overflow:auto;"><table class="tbl"><thead><tr>' + th.map(x=>`<th>${x}</th>`).join('') + '</tr></thead><tbody>';
    for (const row of rows) {
      html += '<tr>' +
        `<td>${escapeHtml(row.login)}</td>`+
        `<td>${row.calls||0}</td>`+
        `<td>${row.ndz||0}</td>`+
        `<td>${row.auto||0}</td>`+
        `<td>${row.refuse||0}</td>`+
        `<td>${row.ivrit||0}</td>`+
        `<td>${row.passed||0}</td>`+
        `<td>${row.kupat||0}</td>`+
        `<td>${row.closed||0}</td>`+
        `<td>${escapeHtml(row.first||'')}</td>`+
        `<td>${escapeHtml(row.last||'')}</td>`+
      '</tr>';
    }
    html += '</tbody></table></div>';
    box.innerHTML = html;
  } catch (e) {
    box.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏';
  }
}

function setupAdminStatsUI() {
  const dateInp = document.getElementById('adminStatsDate');
  const loadBtn = document.getElementById('adminStatsLoadBtn');
  const dlBtn = document.getElementById('adminStatsDownloadBtn');
  const kupatBtn = document.getElementById('kupatExportBtn');

  if (dateInp && !dateInp.value) {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    dateInp.value = `${yyyy}-${mm}-${dd}`;
  }
  if (loadBtn) loadBtn.onclick = () => loadAdminStats();
  if (dateInp) dateInp.onchange = () => loadAdminStats();
  if (dlBtn) dlBtn.onclick = () => {
    if (!me || me.role !== 'admin') return;
    window.open(`/api/admin/stats/download?login=${encodeURIComponent(me.login)}&role=${encodeURIComponent(me.role)}`, '_blank');
  };
  if (kupatBtn) kupatBtn.onclick = () => downloadKupatExcel();
}

function downloadKupatExcel(){
  if(!me || me.role!=='admin') return;
  window.open(`/api/export/kupat?login=${encodeURIComponent(me.login)}&role=${encodeURIComponent(me.role)}`, '_blank');
}

// helpers: safe html

function renderMedia(url){
  if(!url) return '';
  const u = String(url);
  const ext = (u.split('?')[0].split('#')[0].split('.').pop() || '').toLowerCase();
  const isImg = ['jpg','jpeg','png','gif','webp'].includes(ext) || u.startsWith('data:image');
  const isVid = ['mp4','webm','ogg','mov','m4v'].includes(ext) || u.startsWith('data:video');
  if(isImg){
    return `<div class="media"><img src="${escapeAttr(u)}" style="max-width:260px; max-height:180px; border-radius:10px; border:1px solid rgba(255,255,255,.12);" /></div>`;
  }
  if(isVid){
    return `<div class="media"><video src="${escapeAttr(u)}" controls style="max-width:320px; max-height:220px; border-radius:10px; border:1px solid rgba(255,255,255,.12);"></video></div>`;
  }
  return `<div class="media"><a href="${escapeAttr(u)}" target="_blank" class="sip-btn">üìé –§–∞–π–ª</a></div>`;
}

function escapeHtml(s){
    return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

// ===== Assignment dropdowns support (moved inside script) =====
// Users cache (for assignment dropdowns)
let usersCache = [];
async function loadUsersCache(){
  try{
    const r = await fetch('/api/users');
    const d = await r.json();
    usersCache = Array.isArray(d.users) ? d.users : [];
  }catch(e){ usersCache = []; }
}
function usersByRole(role){
  return (usersCache||[]).filter(u=>u && u.role===role).map(u=>u.login);
}
function renderChips(arr, prefix){
  const a = (Array.isArray(arr)?arr:[]).filter(Boolean);
  if(!a.length) return `<span class="who">-</span>`;
  return a.map(x=>`<span class="who" style="margin-right:6px; font-size:15px; font-weight:900;">${escapeHtml(x)}</span>`).join('');
}
async function addAssignee(orderId, listType, selId){
  const sel = document.getElementById(selId);
  const assignee = (sel?.value || '').trim();
  if(!assignee) return;
  try{
    const r = await fetch('/api/orders/assign', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ id: orderId, listType, assignee, requesterLogin: me?.login, requesterRole: me?.role })
    });
    if(!r.ok){ const t=await r.text(); return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å: '+t); }
    // reload current view lists
    if(listType==='tech') await loadOrders('tech');
    if(listType==='closer') await loadOrders('closer');
    // also refresh others that may show same order
    await loadOrders('returns'); 
  }catch(e){ alert('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è'); }
}
// ===== end assignment dropdowns support =====


function escapeAttr(s){ return escapeHtml(s).replace(/\s/g,''); }
function roleTitle(r){
    if(r==='user') return '–û–ø–µ—Ä–∞—Ç–æ—Ä';
    if(r==='tech') return '–¢–µ—Ö–Ω–∏–∫';
    if(r==='closer') return '–ó–∞–∫—Ä—ã–≤';
    if(r==='kupat') return '–ö—É–ø–∞—Ç';
    if(r==='admin') return '–ê–¥–º–∏–Ω';
    return r || '';
}

// –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤ UTC+2 (YYYY-MM-DD HH:MM:SS)
function formatUTC2(ts){
  if(!ts) return '';
  const s = String(ts);
  if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(s)) return s;
  const d0 = new Date(s);
  if (!isNaN(d0.getTime())) {
    const d = new Date(d0.getTime() + 2*60*60*1000);
    const pad = (n)=>String(n).padStart(2,'0');
    return `${d.getUTCFullYear()}-${pad(d.getUTCMonth()+1)}-${pad(d.getUTCDate())} ${pad(d.getUTCHours())}:${pad(d.getUTCMinutes())}:${pad(d.getUTCSeconds())}`;
  }
  return s;
}

function formatDateTimeRuUTC2(ts){
  const s = formatUTC2(ts);
  const m = String(s || '').match(/^(\d{4})-(\d{2})-(\d{2})\s(\d{2}):(\d{2})(?::\d{2})?$/);
  if (!m) return s || '-';
  const [, y, mo, d, h, mi] = m;
  return `${d}.${mo}.${y} ${h}:${mi}`;
}

function canCommentOrder(o){
    if(!me) return false;
    const st = o.status;
    if(me.role === 'admin') return true;

    // –û–ø–µ—Ä –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ –∑–∞—è–≤–∫–∞ —É —Ç–µ—Ö–Ω–∏–∫–∞ (–¥–æ –∑–∞–∫—Ä—ã–≤–∞)
    if(me.role === 'user') return (st === 'new' || st === 're-work' || st === 'return');

    // –¢–µ—Ö–Ω–∏–∫ ‚Äî –ø–æ–∫–∞ –Ω–µ —Ñ–∏–Ω–∞–ª/–Ω–µ –æ—Ç–∫–∞–∑
    if(me.role === 'tech') return (st !== 'final' && st !== 'refuse');

    // –ó–∞–∫—Ä—ã–≤ ‚Äî –Ω–∞ —Å–≤–æ—ë–º —ç—Ç–∞–ø–µ
    if(me.role === 'closer') return (st === 'closer' || st === 'final' || (o.closer && o.closer === me.login));

    return false;
}
async function saveOrderComment(id, textareaId){
    const el = document.getElementById(textareaId);
    if(!el) return;
    const text = (el.value || '').trim();
    const fileEl = document.getElementById(textareaId + '_file');
    const file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;

    if(!text && !file) return alert('–ü—É—Å—Ç–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.');

    const fd = new FormData();
    fd.append('id', id);
    fd.append('role', me.role);
    fd.append('login', me.login);
    fd.append('text', text);
    if(file) fd.append('file', file);

    const r = await fetch('/api/orders/comment', {
        method:'POST',
        body: fd
    });
    if(!r.ok){
        const j = await r.json().catch(()=>({}));
        return alert('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ' + (j.error || r.status));
    }
    el.value = '';
    if(fileEl) fileEl.value = '';
    if(window._activeTab){
      const t = window._activeTab;
      if(['my-orders','tech','returns','closer'].includes(t)) await loadOrders(t);
      if(t==='kupat') await loadKupat();
      if(t==='logs') await loadLogs();
    } // –æ–±–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É
}

// NOTIFY SOUND (WebAudio beep)
let _audioCtx = null;
let _audioUnlocked = false;
function _ensureAudio() {
    if(!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function unlockAudioOnce() {
    if(_audioUnlocked) return;
    _ensureAudio();
    _audioCtx.resume().catch(()=>{});
    _audioUnlocked = true;
    document.removeEventListener('click', unlockAudioOnce);
    document.removeEventListener('touchstart', unlockAudioOnce);
}
document.addEventListener('click', unlockAudioOnce, {once:true});
document.addEventListener('touchstart', unlockAudioOnce, {once:true});

function playNotify() {
    // –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–π, –Ω–æ –º—è–≥–∫–∏–π "chime" (2 —Ç–æ–Ω–∞, –ø–ª–∞–≤–Ω–∞—è –æ–≥–∏–±–∞—é—â–∞—è)
    try {
        _ensureAudio();
        if(_audioCtx.state === 'suspended') _audioCtx.resume().catch(()=>{});
        const t0 = _audioCtx.currentTime;

        const master = _audioCtx.createGain();
        master.gain.setValueAtTime(0.0001, t0);
        master.gain.exponentialRampToValueAtTime(0.18, t0 + 0.02);
        master.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.70);

        const lp = _audioCtx.createBiquadFilter();
        lp.type = 'lowpass';
        lp.frequency.setValueAtTime(3200, t0);
        lp.Q.setValueAtTime(0.7, t0);

        const o1 = _audioCtx.createOscillator();
        const o2 = _audioCtx.createOscillator();
        const g1 = _audioCtx.createGain();
        const g2 = _audioCtx.createGain();

        o1.type = 'triangle';
        o2.type = 'sine';

        // two-step "ding"
        o1.frequency.setValueAtTime(523.25, t0); // C5
        o1.frequency.exponentialRampToValueAtTime(784.00, t0 + 0.18); // G5
        o2.frequency.setValueAtTime(659.25, t0); // E5
        o2.frequency.exponentialRampToValueAtTime(987.77, t0 + 0.18); // B5

        g1.gain.setValueAtTime(0.0001, t0);
        g2.gain.setValueAtTime(0.0001, t0);
        g1.gain.exponentialRampToValueAtTime(0.9, t0 + 0.02);
        g2.gain.exponentialRampToValueAtTime(0.7, t0 + 0.02);
        g1.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.70);
        g2.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.70);

        o1.connect(g1); o2.connect(g2);
        g1.connect(lp); g2.connect(lp);
        lp.connect(master);
        master.connect(_audioCtx.destination);

        o1.start(t0); o2.start(t0);
        o1.stop(t0 + 0.72); o2.stop(t0 + 0.72);
    } catch(e) { /* ignore */ }
}

// POLLING for new incoming orders (tech/closer)
let _seenTechIds = new Set();
let _seenCloserIds = new Set();
let _pollReady = false;

async function pollIncoming() {
    if(!me) return;
    try {
        if(me.role === 'tech') {
            const r = await fetch(`/api/orders?login=${me.login}&role=${me.role}&view=tech`);
            let data = await r.json();
            // incoming for tech: new / re-work (—Ä–µ–∞–ª—å–Ω—ã–µ "–ø—Ä–∏—à–ª–∏")
            const incoming = data.filter(o => o.status === 'new' || o.status === 're-work');
            const ids = new Set(incoming.map(o => o.id));
            if(_pollReady) {
                let isNew = false;
                for(const id of ids) if(!_seenTechIds.has(id)) { isNew = true; break; }
                if(isNew) playNotify();
            }
            _seenTechIds = ids;
        }

        if(me.role === 'closer') {
            const r = await fetch(`/api/orders?login=${me.login}&role=${me.role}&view=closer`);
            let data = await r.json();
            const incoming = data.filter(o => o.status === 'closer');
            const ids = new Set(incoming.map(o => o.id));
            if(_pollReady) {
                let isNew = false;
                for(const id of ids) if(!_seenCloserIds.has(id)) { isNew = true; break; }
                if(isNew) playNotify();
            }
            _seenCloserIds = ids;
        }

        _pollReady = true;
    } catch(e) {}
}


// --- AUTH & NAV ---
async function login() {
    const msgEl = document.getElementById('loginMsg');
    const setMsg = (t) => {
        if(!msgEl) return;
        msgEl.style.display = t ? 'block' : 'none';
        msgEl.textContent = t || '';
    };

    try {
        setMsg('');

        const loginEl = document.getElementById('logIn');
        const passEl  = document.getElementById('pasIn');
        const loginV = (loginEl?.value || '').trim();
        const passV  = (passEl?.value  || '').trim();
        const r = await fetch('/api/login', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({login: loginV, pass: passV})
        });

        let res = {};
        try { res = await r.json(); } catch(e) { res = {}; }

        if(r.ok && res.success) {
            me = res.user;
            document.getElementById('auth-shell').classList.add('hidden');
            document.getElementById('auth-box').classList.add('hidden');
            document.getElementById('main-ui').classList.remove('hidden');
            document.getElementById('uLabel').innerText = me.login;
            document.getElementById('rLabel').innerText = (me.role || '').toUpperCase();
            setupNav();
            if(me.role==='tech' || me.role==='closer') {
                document.getElementById('soundHint').innerText = 'üîî –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ';
            }
            try{ await loadUsersCache(); }catch(e){}
			setupAdminStatsUI();

// prefetch my stats
        try{ await loadMyStats(); }catch(e){}

            wireIncomeInputs();
            setMyTitle();
            pollIncoming();
            setInterval(pollIncoming, 8000);
        } else {
            // –ü–æ–∫–∞–∂–µ–º –ø–æ–Ω—è—Ç–Ω–µ–µ, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Å–ª—É—á–∏–ª–æ—Å—å
            if (r.status === 401) { setMsg('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å'); }
            else { setMsg('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + r.status + ' ' + (res.error || '')); }
        }
    } catch(e) {
        console.error(e);
        setMsg('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞/—Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ server.js –∑–∞–ø—É—â–µ–Ω –∏ /api/login –¥–æ—Å—Ç—É–ø–µ–Ω.');
    }
}

function setupNav() {
    const nav = document.getElementById('nav-buttons');
    let html = '';
    const r = me.role;

    const exitBtn = `<button onclick="location.reload()" class="btn-gray">–í—ã—Ö–æ–¥</button>`;

    if(r === 'admin'){
        html += `<button onclick="openTab('work')">üìû –û–±–∑–≤–æ–Ω</button>`;
        html += `<button onclick="openTab('notes')">üìù –ó–∞–º–µ—Ç–∫–∏</button>`;
        html += `<button onclick="openTab('create-order')">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>`;
        html += `<button onclick="openTab('my-orders')">–ò—Å—Ç–æ—Ä–∏—è</button>`;
        html += `<button onclick="openTab('tech')">üõ† –¢–µ—Ö–Ω–∏–∫</button>`;
        html += `<button onclick="openTab('tech-my')">üß∞ –ú–æ–∏ —Ç–µ—Ö–Ω–∏–∫–∏</button>`;
        html += `<button onclick="openTab('returns')">‚Ü© –í–æ–∑–≤—Ä–∞—Ç—ã</button>`;
        html += `<button onclick="openTab('closer')">‚úÖ –ó–∞–∫—Ä—ã–≤</button>`;
        html += `<button onclick="openTab('kupat')">üè∑ –ö—É–ø–∞—Ç</button>`;
                html += `<button onclick="openTab('income')">üíµ –î–æ—Ö–æ–¥</button>`;
        html += `<button onclick="openTab('logs')">üìí –õ–æ–≥ –∑–≤–æ–Ω–∫–æ–≤</button>`;
        html += `<button onclick="openTab('admin')">üßë‚Äçüíº –ê–¥–º–∏–Ω</button>`;
        html += `<button onclick="openTab('admin-stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>`;
		        html += `<button onclick="openTab('callbacks')">üîÅ –ü–µ—Ä–µ–∑–≤–æ–Ω</button>`;
        nav.innerHTML = html + exitBtn;
        return;
    }

    if(r === 'user') {
        html += `<button onclick="openTab('work')">üìû –û–±–∑–≤–æ–Ω</button>`;
        html += `<button onclick="openTab('notes')">üìù –ó–∞–º–µ—Ç–∫–∏</button>`;
        html += `<button onclick="openTab('create-order')">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>`;
        html += `<button onclick="openTab('my-orders')">–ò—Å—Ç–æ—Ä–∏—è</button>`;
		html += `<button onclick="openTab('callbacks')">üîÅ –ü–µ—Ä–µ–∑–≤–æ–Ω</button>`;
    }
    if(r === 'tech') {
        html += `<button onclick="openTab('tech')">üõ† –í—Ö–æ–¥—è—â–∏–µ</button>`;
        html += `<button onclick="openTab('tech-my')">üß∞ –ú–æ–∏ —Ç–µ—Ö–Ω–∏–∫–∏</button>`;
	    html += `<button onclick="openTab('callbacks')">üîÅ –ü–µ—Ä–µ–∑–≤–æ–Ω—ã</button>`;
		html += `<button onclick="openTab('notes')">üìù –ó–∞–º–µ—Ç–∫–∏</button>`;
        html += `<button onclick="openTab('create-order')">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>`;
        html += `<button onclick="openTab('my-orders')">–ò—Å—Ç–æ—Ä–∏—è</button>`;
    }
    if(r === 'closer') {
        html += `<button onclick="openTab('closer')">‚úÖ –ó–∞–∫—Ä—ã–≤</button>`;
        html += `<button onclick="openTab('notes')">üìù –ó–∞–º–µ—Ç–∫–∏</button>`;
        html += `<button onclick="openTab('create-order')">‚ûï –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>`;
        html += `<button onclick="openTab('kupat')">üè∑ –ö—É–ø–∞—Ç</button>`;
    }
    if(r === 'kupat') {
		html += `<button onclick="openTab('kupat')">üè∑ –í—Ö–æ–¥—è—â–∏–µ –ö—É–ø–∞—Ç</button>`;
        html += `<button onclick="openTab('kupat-my-clients')">üë¥ –ú–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã</button>`;
        html += `<button onclick="openTab('kupat-my-transfers')">üì§ –ú–æ–∏ –ø–µ—Ä–µ–¥–∞—á–∏</button>`;
		html += `<button onclick="openTab('notes')">üìù –ó–∞–º–µ—Ç–∫–∏</button>`;
		html += `<button onclick="openTab('callbacks')">üîÅ –ü–µ—Ä–µ–∑–≤–æ–Ω</button>`;
    }
    if(r === 'tech' || r === 'user') {
        html += `<button onclick="openTab('returns')">‚Ü© –í–æ–∑–≤—Ä–∞—Ç—ã</button>`;
    }

        nav.innerHTML = html + exitBtn;
}


function setMyTitle() {
    const el = document.getElementById('my-title');
    if(!el) return;
    if(me.role === 'user' || me.role === 'admin') el.innerText = 'üì§ –ú–æ–∏ –ø–µ—Ä–µ–¥–∞—á–∏';
    else if(me.role === 'tech') el.innerText = 'üõ† –ú–æ—è –∏—Å—Ç–æ—Ä–∏—è (–¢–µ—Ö–Ω–∏–∫)';
    else if(me.role === 'closer') el.innerText = 'üí∞ –ú–æ—è –∏—Å—Ç–æ—Ä–∏—è (–ó–∞–∫—Ä—ã–≤)';
    else el.innerText = 'üì§ –ò—Å—Ç–æ—Ä–∏—è';
}

async function openTab(name) {
    window._activeTab = name;
    if(name === 'income' && me && me.role !== 'admin') return;

    // Hide all
    ['tab-work','tab-create-order','tab-my-orders','tab-notes','tab-callbacks','tab-tech','tab-tech-my','tab-returns','tab-closer','tab-kupat','tab-kupat-my-clients','tab-kupat-my-transfers','tab-income','tab-logs','tab-admin','tab-admin-stats']
        .forEach(id => { const el = document.getElementById(id); if(el) el.classList.add('hidden'); });
    
    // Show one
    const showEl = document.getElementById('tab-'+name);
    if(showEl) showEl.classList.remove('hidden');
    
    // Load Data
    if(name === 'notes') { await loadNotes(); }
    if(name === 'callbacks') { await loadCallbacks(); }
    if(name === 'my-orders') { setMyTitle(); loadOrders('my-orders'); }
    if(name === 'tech') loadOrders('tech');
    if(name === 'tech-my') loadOrders('tech-my');
    if(name === 'returns') loadOrders('returns');
    if(name === 'closer') loadOrders('closer');
    if(name === 'kupat') loadKupat();
    if(name === 'kupat-my-clients') loadKupatMyClients();
    if(name === 'kupat-my-transfers') loadKupatMyTransfers();
    if(name === 'income') { /* placeholder */ }
    if(name === 'logs') loadLogs();
    if(name === 'admin') { loadStats(); loadDbs(); }    if(name === 'admin-stats') { await loadAdminStats(); }
}

window.openTab = openTab;


function buildCallTemplateFromRow(row){
    const A = (row?.[0] ?? '').toString().trim();
    const B = (row?.[1] ?? '').toString().trim();
    const C = (row?.[2] ?? '').toString().trim();
    const D = (row?.[3] ?? '').toString().trim();
    const E = (row?.[4] ?? '').toString().trim();
    const F = (row?.[5] ?? '').toString().trim();

    return [
        `–ò–º—è: ${A}`,
        `–ù–æ–º–µ—Ä: ${B}`,
        `–ü—Ä–æ–±–ª–µ–º–∞: –¢–µ–ª–µ–≤–∏–¥–µ–Ω—å–µ, —Ä–∞–±–æ—Ç—ã –Ω–∞ 10-14 –¥–Ω–µ–π, —Å–∏–≥–Ω–∞–ª –Ω–µ —Å–ª–æ–≤–∏—Ç –≤—Å–µ –∫–∞–Ω–∞–ª—ã, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–Ω–∞–ª—ã –Ω—É–∂–Ω–æ.`,
        `–î–æ–º–∞:`,
        `–ö–∞–Ω–∞–ª—ã –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å:`,
        `–¢–ó: ${C}`,
        `–ê–¥—Ä–µ—Å: ${D}`,
        `–í–æ–∑—Ä–∞—Å—Ç: ${E}`,
        ``,
        ``,
        `–î–æ–ø.–ò–Ω—Ñ–∞: ${F}`,
        `-`
    ].join('\n');
}
// --- WORKER FLOW ---
async function nextClient() {
    const r = await fetch('/api/get-row');
    const d = await r.json();
    if(d.error) return alert(d.error);
    
    curClient = { name: d.row[0], phone: d.row[1], tz: d.row[2], address: d.row[3], age: d.row[4], extra: d.row[5], row: d.row }; window.curClient = curClient;
    const area = document.getElementById('client-area');
    
    area.innerHTML = `
        <h2 style="margin:0">${curClient.name}</h2>
        <h1 style="color:#2f81f7; font-size:32px; margin:10px 0">${curClient.phone}</h1>
        <a href="sip:${curClient.phone}" class="sip-btn" onclick="trackEvent('CALL', curClient.phone)">üìû –ü–û–ó–í–û–ù–ò–¢–¨</a>
        
        <div class="action-grid">
            <button class="btn-yel" onclick="sendResult('–ù–î–ó')">–ù–î–ó</button>
            <button class="btn-blue" onclick="sendResult('–ê–í–¢–û')">–ê–í–¢–û</button>
            <button class="btn-pur" onclick="sendResult('–ò–í–†–ò–¢')">–ò–í–†–ò–¢</button>
            <button class="btn-red" onclick="sendResult('–û–¢–ö–ê–ó')">–û–¢–ö–ê–ó</button>
            <button style="background:#e67e22" onclick="sendResult('–ù–ê –ö–£–ü–ê–¢')">–ù–ê –ö–£–ü–ê–¢</button>
            <button style="background:#238636" onclick="sendResult('–ü–ï–†–ï–î–ê–õ')">–ü–ï–†–ï–î–ê–õ</button>
        </div>
        <div style="margin-top:10px"><button class="btn-vio" onclick="addCurrentToNotes()" style="width:100%; padding:12px; font-size:14px;">–í –ó–ê–ú–ï–¢–ö–ò</button></div>
		<div style="margin-top:8px"><button class="btn-gray" onclick="addCurrentToCallbacks()" style="width:100%; padding:10px; font-size:14px;">üîÅ –í –ü–ï–†–ï–ó–í–û–ù</button></div>
    `;
    document.getElementById('note').value = buildCallTemplateFromRow(curClient.row || []);
}

async function sendResult(status) {
    trackEvent(status, curClient?.phone || '', document.getElementById('note')?.value || '');
    const note = document.getElementById('note').value;
    await fetch('/api/save-result', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ status, user: me.login, phone: curClient.phone, name: curClient.name, note })
    });
    nextClient(); // –°—Ä–∞–∑—É —Å–ª–µ–¥—É—é—â–∏–π
}

// --- RENDERING LISTS ---
async function loadOrders(type) {
    const r = await fetch(`/api/orders?login=${me.login}&role=${me.role}&view=${type}`);
    let data = await r.json();
    try{ ordersCache[type] = Array.isArray(data) ? data : []; }catch(e){}
    let container = '';
    
    // Filtering on Client (Visualization)
// Filtering on Client (Visualization)
if(type === 'tech') {
    data = data.filter(o => o.status === 'new' || o.status === 're-work');
}
if(type === 'tech-my') {
    data = data.filter(o => o.status === 'tech_work');
}
if(type === 'returns') {
    data = data.filter(o => o.status === 'return');
}
if(type === 'closer') {
    data = data.filter(o => o.status === 'closer' || o.status === 'final');
}
    
    const targetByType = {
        'my-orders': 'list-my',
        'tech': 'list-tech',
        'tech-my': 'list-tech-my',
        'returns': 'list-returns',
        'closer': 'list-closer'
    };
    const target = targetByType[type] || 'list-closer';
    
    document.getElementById(target).innerHTML = data.reverse().map(o => {
        const cid = `c_${type}_${o.id}`;
        const canC = canCommentOrder(o);
        const canUpload = (me.role==='tech'||me.role==='closer'||me.role==='admin');
        const comments = Array.isArray(o.comments) ? o.comments : [];
        const commentsHtml = renderOrderComments(comments);
        const commentEditorHtml = renderOrderCommentEditor(o, cid, canC, canUpload);


        return `
        <div class="order-item ${o.status}">
            ${me.role === 'admin' ? `<button onclick="delItem(${o.id}, 'orders')" class="btn-red" style="float:right; padding:2px 6px; font-size:10px">X</button>` : ''}

            <div class="order-grid">
                <div class="order-head">
                    <div>
                        <div class="order-title">${escapeHtml(o.clientName || '')}</div>
                        <div class="order-phone">${escapeHtml(o.phone || '')} <span class="badge">${escapeHtml(o.status || '')}</span></div>
                    </div>
                    <a href="sip:${escapeAttr(o.phone || '')}" style="display:inline-block; background:#2f81f7; color:#fff; padding:8px 12px; border-radius:10px; text-decoration:none; font-size:13px; font-weight:800;">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>
                </div>

                <div class="pillbar">
                    <span class="pill"><small>–û–ø–µ—Ä</small> <span class="who">${escapeHtml(o.operator || '-')}</span></span>
                    <span class="pill"><small>–¢–µ—Ö</small>
                      <span class="who" style="display:inline-flex; flex-wrap:wrap; align-items:center; gap:6px;">
                        ${renderChips(o.techs || (o.tech?[o.tech]:[]), '–¢–µ—Ö')}
                      </span>
                      ${(me.role==='tech'||me.role==='admin') ? `
                        <div style="margin-top:6px; display:flex; gap:6px; align-items:center;">
                          <select id="techSel_${cid}" style="flex:1; padding:6px; border-radius:10px; background:#0b1320; color:#fff; border:1px solid #30363d;">
                            ${usersByRole('tech').map(u=>`<option value="${escapeAttr(u)}"${u===me.login?' selected':''}>${escapeHtml(u)} (–¢–µ—Ö–Ω–∏–∫)</option>`).join('')}
                          </select>
                          <button class="btn-vio" style="padding:6px 10px" onclick="addAssignee(${o.id}, 'tech', 'techSel_${cid}')">+</button>
                        </div>
                      ` : ''}
                    </span>
                    <span class="pill"><small>–ó–∞–∫—Ä—ã–≤</small>
                      <span class="who" style="display:inline-flex; flex-wrap:wrap; align-items:center; gap:6px;">
                        ${renderChips(o.closers || (o.closer?[o.closer]:[]), '–ó–∞–∫—Ä—ã–≤')}
                      </span>
                      ${(me.role==='closer'||me.role==='admin') ? `
                        <div style="margin-top:6px; display:flex; gap:6px; align-items:center;">
                          <select id="closerSel_${cid}" style="flex:1; padding:6px; border-radius:10px; background:#0b1320; color:#fff; border:1px solid #30363d;">
                            ${usersByRole('closer').map(u=>`<option value="${escapeAttr(u)}"${u===me.login?' selected':''}>${escapeHtml(u)} (–ó–∞–∫—Ä—ã–≤)</option>`).join('')}
                          </select>
                          <button class="btn-vio" style="padding:6px 10px" onclick="addAssignee(${o.id}, 'closer', 'closerSel_${cid}')">+</button>
                        </div>
                      ` : ''}
                    </span>
                </div>

                <div class="kvcol">
                    <div class="k">–ò–Ω—Ñ–æ</div>
                    <div class="v">${escapeHtml(o.details || '')}</div>
                </div>

                ${o.opToTechAt ? `<div class="kvcol"><div class="k">–û–ø–µ—Ä‚Üí–¢–µ—Ö</div><div class="v">${escapeHtml(formatUTC2(o.opToTechAt))}</div></div>` : ''}
                ${o.techToCloserAt ? `<div class="kvcol"><div class="k">–¢–µ—Ö‚Üí–ó–∞–∫—Ä—ã–≤</div><div class="v">${escapeHtml(formatUTC2(o.techToCloserAt))}</div></div>` : ''}

                ${o.techInfo ? `<div class="kvcol"><div class="k">–¢–µ—Ö –∏–Ω—Ñ–æ</div><div class="v">${escapeHtml(o.techInfo)}</div></div>` : ''}
                ${o.operatorComment ? `<div class="kvcol"><div class="k">–û–ø–µ—Ä –∏–Ω—Ñ–æ</div><div class="v">${escapeHtml(o.operatorComment)}</div></div>` : ''}
                ${o.finalText ? `<div style="border:1px solid ${o.finalColor}; padding:10px; border-radius:10px; margin-top:6px"><b>üèÅ –ò–¢–û–ì:</b> ${escapeHtml(o.finalText)}</div>` : ''}

                <div style="margin-top:8px; border-top:1px solid #30363d; padding-top:10px">
                    ${((me.role === 'tech' || me.role === 'admin') && type==='tech-my') ? `<button class="btn-red" onclick="deleteOrderAsTech(${o.id})">–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É</button>` : ''}
                    ${((me.role === 'tech' || me.role === 'admin') && (o.status==='new'||o.status==='re-work')) ? `<button class="btn-blue" onclick="techTakeInWork(${o.id})">–í–ó–Ø–¢–¨ –í –†–ê–ë–û–¢–£</button>` : ''}

                    ${((me.role === 'tech' || me.role === 'admin') && (o.status==='new'||o.status==='re-work'||o.status==='tech_work')) ? `<button class="btn-yel" onclick="openTechOrderActionModal(${o.id}, 'return')">–ù–î–ó (–í–µ—Ä–Ω—É—Ç—å)</button><button class="btn-red" onclick="openTechOrderActionModal(${o.id}, 'refuse')">–û–¢–ö–ê–ó</button><button class="btn-pur" onclick="openTechOrderActionModal(${o.id}, 'closer')">–ù–ê –ó–ê–ö–†–´–í</button><button class="btn-gray" onclick="moveTechToCallback(${o.id})">–ü–ï–†–ï–ó–í–û–ù</button>` : ''}

                    ${(me.role === 'user' || me.role === 'admin') && o.status==='return' ? `
                        <button class="btn-blue" onclick="returnToTech(${o.id})">–í–µ—Ä–Ω—É—Ç—å —Ç–µ—Ö–Ω–∏–∫—É</button>
                    ` : ''}

                    ${(me.role === 'closer' || me.role === 'admin') && o.status==='closer' ? `
                        <button class="btn-blue" onclick="finalOrder(${o.id})">–§–ò–ù–ê–õ</button>
                    ` : ''}
                    ${(me.role === 'closer' || me.role === 'admin') ? `
                        <button class="btn-vio" onclick="addOrderToNotes(${o.id}, '${type}')">–í –ó–ê–ú–ï–¢–ö–ò</button>
                    ` : ''}
                </div>

                ${commentsHtml}

                ${commentEditorHtml}
            </div>
        </div>
        `;
    }).join('');
}

function renderKupatInfoBlock(o){
    const operator = o.operatorFrom || o.operator || '-';
    const kupatUser = o.kupatUser || '-';
    const closer = o.closer || '-';
    const opToKupatTime = o.opToKupatAt ? formatUTC2(o.opToKupatAt) : '-';
    return `
        <div class="pillbar" style="margin-top:8px">
            <span class="pill"><small>–û–ø–µ—Ä</small> <span class="who">${escapeHtml(operator)}</span></span>
            <span class="pill"><small>–ö—É–ø–∞—Ç</small> <span class="who">${escapeHtml(kupatUser)}</span></span>
            <span class="pill"><small>–ó–∞–∫—Ä—ã–≤</small> <span class="who">${escapeHtml(closer)}</span></span>
            <span class="pill"><small>–°—Ç–∞—Ç—É—Å</small> <span class="who">${escapeHtml(o.status || '-')}</span></span>
            <span class="pill"><small>–í—Ä–µ–º—è</small> <span class="who">${escapeHtml(opToKupatTime)}</span></span>
        </div>
        ${o.kupatToCloserAt ? `<div class="kvcol" style="margin-top:8px"><div class="k">–ö—É–ø–∞—Ç‚Üí–ó–∞–∫—Ä—ã–≤</div><div class="v">${escapeHtml(formatUTC2(o.kupatToCloserAt))}</div></div>` : ''}
        <div class="kvcol" style="margin-top:10px">
            <div class="k">–ò–Ω—Ñ–æ</div>
            <div class="v">${escapeHtml(o.details || '')}</div>
        </div>
        ${o.kupatNote ? `<div style="color:#d29922; font-size:12px; margin-top:8px">üë¥ –ó–∞–º–µ—Ç–∫–∞: ${escapeHtml(o.kupatNote)}</div>` : ''}
        ${o.finalText ? `<div style="border:1px solid ${escapeAttr(o.finalColor || '#30363d')}; border-radius:10px; padding:8px; margin-top:8px">üèÅ –ò–¢–û–ì: ${escapeHtml(o.finalText)}</div>` : ''}
    `;
}

function renderKupatComments(comments){
    const list = uniqueComments(comments);
    const rows = list.slice().reverse().map(c => `
        <div class="comment-item" style="margin-top:8px">
            <div class="meta">üí¨ <b>${escapeHtml(roleTitle(c.role || 'kupat'))}</b> <span class="badge">${escapeHtml(c.by || '-')}</span> ¬∑ ${escapeHtml(c.time || '')}</div>
            <div class="text">${escapeHtml(c.text || '')}</div>
            ${c.fileUrl ? renderMedia(c.fileUrl) : ''}
        </div>
    `).join('');
    return `
      <div style="margin-top:10px">
        <div style="font-weight:800; margin-bottom:8px">üìö –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
        ${rows || '<div class="badge">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>'}
      </div>
    `;
}

function renderKupatCommentEditor(o){
    return `
      <div class="comment-box" style="margin-top:10px">
          <div style="font-weight:800; margin-bottom:8px">üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
          <textarea id="kupat_comment_${o.id}" placeholder="–ù–∞–ø–∏—à–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
          <div style="margin-top:8px"><input type="file" id="kupat_comment_${o.id}_file" accept="image/*,video/*" /></div>
          <div style="margin-top:8px">
              <button class="btn-blue" onclick="saveKupatComment(${o.id}, 'kupat_comment_${o.id}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
          </div>
      </div>
    `;
}
function renderOrderComments(comments){
    const list = uniqueComments(comments);
    if(!list.length) return '';
    return `
        <div class="comment-list" style="margin-top:10px">
            ${list.slice().reverse().map(c => `
                <div class="comment">
                    <div class="meta">üí¨ <b>${roleTitle(c.role)}</b> <span class="badge">${c.by}</span> ¬∑ ${c.time}</div>
                    <div class="txt">${escapeHtml(c.text)}</div>${c.file ? renderMedia(c.file) : ""}
                </div>
            `).join('')}
        </div>
    `;
}

function uniqueComments(comments){
    const list = Array.isArray(comments) ? comments : [];
    const seen = new Set();
    return list.filter(c => {
        const key = [c?.by || '', c?.role || '', c?.text || '', c?.file || '', c?.fileUrl || ''].join('|');
        if(seen.has(key)) return false;
        seen.add(key);
        return true;
    });
}

function renderOrderCommentEditor(o, cid, canC, canUpload){
    if(!canC) return '';
    return `
        <div class="comment-box" style="margin-top:10px">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px">
                <div style="font-weight:800">üìù –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
                <div style="font-size:11px; color:#8b949e">${me.role==='user' ? '–û–ø–µ—Ä –º–æ–∂–µ—Ç –ø–∏—Å–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ–∫–∞ –∑–∞—è–≤–∫–∞ —É —Ç–µ—Ö–Ω–∏–∫–∞.' : ''}</div>
            </div>
            <textarea id="${cid}" placeholder="–ù–∞–ø–∏—à–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            ${canUpload ? `<div style="margin-top:8px"><input type="file" id="${cid}_file" accept="image/*,video/*" /></div>` : ''}
            <div style="margin-top:8px">
                <button class="btn-blue" onclick="saveOrderComment(${o.id}, '${cid}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </div>
        </div>
    `;
}


async function loadKupat() {
    const r = await fetch(`/api/kupat/list?login=${me.login}&role=${me.role}&view=${me.role==='kupat'?'incoming':'for-closer'}`);
    const data = await r.json();

    const kupatAssignees = [...usersByRole('kupat'), ...usersByRole('admin')].filter((u, i, arr) => u && arr.indexOf(u) === i);
    const closerAssignees = [...usersByRole('closer'), ...usersByRole('admin')].filter((u, i, arr) => u && arr.indexOf(u) === i);

    const renderIncomingItem = (o) => {
        const selectedUser = o.kupatUser || me.login;
        const assigneeSelectId = `kupatAssignee_${o.id}`;
        return `
        <div class="order-item kupat">
            ${(me.role === 'admin') ? `<button onclick="delItem(${o.id}, 'kupat')" class="btn-red" style="float:right; padding:2px 6px; font-size:10px">X</button>` : ''}
            <div class="order-head">
                <div>
                    <div class="order-title">${escapeHtml(o.clientName || '')}</div>
                    <div class="order-phone">${escapeHtml(o.phone || '')}</div>
                </div>
                <a href="sip:${escapeAttr(o.phone || '')}" style="display:inline-block; background:#2f81f7; color:#fff; padding:8px 12px; border-radius:10px; text-decoration:none; font-size:13px; font-weight:800" onclick="trackEvent('CALL', '${escapeAttr(o.phone || '')}')">üìû –ó–í–û–ù–û–ö –ö–£–ü–ê–¢</a>
            </div>

            ${renderKupatInfoBlock(o)}

            <div style="margin-top:10px; display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
                <select id="${assigneeSelectId}" style="min-width:200px; max-width:280px; background:#0b1320; color:#fff; border:1px solid #30363d; border-radius:8px; padding:6px;">
                    ${(kupatAssignees.length ? kupatAssignees : [me.login]).map(u=>`<option value="${escapeAttr(u)}" ${u===selectedUser?'selected':''}>${escapeHtml(u)}</option>`).join('')}
                </select>
                <button style="background:#238636" onclick="kupatTakeInWork(${o.id}, '${assigneeSelectId}')">–í–ó–Ø–¢–¨ –í –†–ê–ë–û–¢–£</button>
                <button class="btn-red" onclick="kupatTakeRefuse(${o.id}, '${assigneeSelectId}')">–û–¢–ö–ê–ó</button>
            </div>
        </div>`;
    };

    const renderCloserItem = (o) => {
        const closerSel = `kupatCloserSel_${o.id}`;
        const currentCloser = o.closer || me.login;
        return `
        <div class="order-item kupat">
            ${(me.role === 'admin') ? `<button onclick="delItem(${o.id}, 'kupat')" class="btn-red" style="float:right; padding:2px 6px; font-size:10px">X</button>` : ''}
            <div class="order-head">
                <div>
                    <div class="order-title">${escapeHtml(o.clientName || '')}</div>
                    <div class="order-phone">${escapeHtml(o.phone || '')}</div>
                </div>
                <a href="sip:${escapeAttr(o.phone || '')}" style="display:inline-block; background:#2f81f7; color:#fff; padding:8px 12px; border-radius:10px; text-decoration:none; font-size:13px; font-weight:800" onclick="trackEvent('CALL', '${escapeAttr(o.phone || '')}')">üìû –ó–í–û–ù–û–ö</a>
            </div>

            ${renderKupatInfoBlock(o)}

            ${(me.role === 'closer' || me.role === 'admin') && o.status === 'kupat_to_closer' ? `
                <div style="margin-top:10px; display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                    <select id="${closerSel}" style="min-width:220px; max-width:320px; padding:6px; border-radius:10px; background:#0b1320; color:#fff; border:1px solid #30363d;">
                        ${(closerAssignees.length ? closerAssignees : [me.login]).map(u=>`<option value="${escapeAttr(u)}" ${u===currentCloser?'selected':''}>${escapeHtml(u)} (–ó–∞–∫—Ä—ã–≤)</option>`).join('')}
                    </select>
                    <button class="btn-vio" style="padding:6px 10px" onclick="kupatAssignCloser(${o.id}, '${closerSel}')">+</button>
                    <button class="btn-blue" onclick="kupatFinal(${o.id})">–§–ò–ù–ê–õ –ö–£–ü–ê–¢</button>
                </div>
            ` : ''}
        </div>`;
    };

    if (me.role === 'kupat' || me.role === 'admin') {
        document.getElementById('list-kupat').innerHTML = data.slice().reverse().map(renderIncomingItem).join('') || '<div class="badge">–ü—É—Å—Ç–æ</div>';
    } else {
        document.getElementById('list-kupat').innerHTML = data.slice().reverse().map(renderCloserItem).join('') || '<div class="badge">–ü—É—Å—Ç–æ</div>';
    }
}

async function loadKupatMyClients() {
    const r = await fetch(`/api/kupat/list?login=${me.login}&role=${me.role}&view=all`);
    const data = await r.json();
    const mine = (Array.isArray(data) ? data : []).filter(o => o.kupatUser === me.login);

    const active = mine.filter(o => o.status === 'kupat_work');
    const archive = mine.filter(o => ['kupat_ndz','kupat_auto','kupat_ivrit','kupat_refuse','kupat_final'].includes(o.status));

    const renderMine = (o) => `
        <div class="order-item kupat">
            ${(me.role === 'kupat' || me.role === 'admin') && ['kupat_ndz','kupat_auto','kupat_ivrit','kupat_refuse','kupat_final'].includes(o.status) ? `<button onclick="delItem(${o.id}, 'kupat')" class="btn-red" style="float:right; padding:2px 6px; font-size:10px">X</button>` : ''}
            <div class="order-head">
                <div>
                    <div class="order-title">${escapeHtml(o.clientName || '')}</div>
                    <div class="order-phone">${escapeHtml(o.phone || '')}</div>
                </div>
                <a href="sip:${escapeAttr(o.phone || '')}" style="display:inline-block; background:#2f81f7; color:#fff; padding:8px 12px; border-radius:10px; text-decoration:none; font-size:13px; font-weight:800" onclick="trackEvent('CALL', '${escapeAttr(o.phone || '')}')">üìû –ó–í–û–ù–û–ö –ö–£–ü–ê–¢</a>
            </div>

            ${renderKupatInfoBlock(o)}

            <div style="margin-top:10px">
                ${o.status === 'kupat_work' ? `
                    <button class="btn-yel" onclick="kupatAction(${o.id}, 'kupat_ndz')">–ù–î–ó</button>
                    <button class="btn-blue" onclick="kupatAction(${o.id}, 'kupat_auto')">–ê–í–¢–û</button>
                    <button class="btn-pur" onclick="kupatAction(${o.id}, 'kupat_ivrit')">–ò–í–†–ò–¢</button>
                    <button style="background:#238636" onclick="kupatAction(${o.id}, 'kupat_to_closer')">–ü–ï–†–ï–î–ê–¢–¨</button>
                    <button class="btn-red" onclick="kupatAction(${o.id}, 'kupat_refuse')">–û–¢–ö–ê–ó</button>
                    <button class="btn-gray" onclick="moveKupatToCallback(${o.id})">–ü–ï–†–ï–ó–í–û–ù</button>
                ` : ''}
            </div>
			
			${renderKupatComments(o.comments)}

            ${renderKupatCommentEditor(o)}
        </div>
    `;
	
    document.getElementById('list-kupat-my-clients').innerHTML = `
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px">
            <span class="badge">–í —Ä–∞–±–æ—Ç–µ: ${active.length}</span>
            <span class="badge">–ê—Ä—Ö–∏–≤: ${archive.length}</span>
        </div>
		<h4 style="margin:10px 0 5px 0">üë¥ –ú–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã (–≤ —Ä–∞–±–æ—Ç–µ)</h4>
        ${active.slice().reverse().map(renderMine).join('') || '<div class="badge">–ü—É—Å—Ç–æ</div>'}
        <h4 style="margin:15px 0 5px 0">üìö –ê—Ä—Ö–∏–≤</h4>
        ${archive.slice().reverse().map(renderMine).join('') || '<div class="badge">–ü—É—Å—Ç–æ</div>'}
        </div>
    `;
}

async function loadKupatMyTransfers() {
    const r = await fetch(`/api/kupat/list?login=${me.login}&role=${me.role}&view=all`);
    const data = await r.json();
    const mineTransfers = (Array.isArray(data) ? data : []).filter(o => o.kupatUser === me.login && (o.status === 'kupat_to_closer' || o.status === 'kupat_final'));
    const inWork = mineTransfers.filter(o => o.status === 'kupat_to_closer');
    const closed = mineTransfers.filter(o => o.status === 'kupat_final');

    const renderTransfer = (o) => `
        <div class="order-item kupat">
            ${(me.role === 'admin') ? `<button onclick="delItem(${o.id}, 'kupat')" class="btn-red" style="float:right; padding:2px 6px; font-size:10px">X</button>` : ''}
            <div class="order-head">
                <div>
                    <div class="order-title">${escapeHtml(o.clientName || '')}</div>
                    <div class="order-phone">${escapeHtml(o.phone || '')}</div>
                </div>
                <a href="sip:${escapeAttr(o.phone || '')}" style="display:inline-block; background:#2f81f7; color:#fff; padding:8px 12px; border-radius:10px; text-decoration:none; font-size:13px; font-weight:800" onclick="trackEvent('CALL', '${escapeAttr(o.phone || '')}')">üìû –ó–í–û–ù–û–ö</a>
            </div>
            ${renderKupatInfoBlock(o)}
        </div>
    `;

    document.getElementById('list-kupat-my-transfers').innerHTML = `
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px">
            <span class="badge">–í —Ä–∞–±–æ—Ç–µ: ${inWork.length}</span>
            <span class="badge">–ó–∞–∫—Ä—ã—Ç–æ: ${closed.length}</span>
        </div>
        ${mineTransfers.slice().reverse().map(renderTransfer).join('') || '<div class="badge">–ü—É—Å—Ç–æ</div>'}
    `;
}


// --- LOGIC FUNCTIONS ---
let techActionModalState = null;

function findOrderInCacheById(id){
    const all = []
      .concat(ordersCache['tech'] || [])
      .concat(ordersCache['tech-my'] || [])
      .concat(ordersCache['returns'] || []);
    return all.find(x => String(x.id) === String(id)) || null;
}

function getTechActionUi(type){
    if(type === 'closer') return { title:'–ü–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ –∑–∞–∫—Ä—ã–≤', save:'–ü–µ—Ä–µ–¥–∞—Ç—å', placeholder:'–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã–≤–∞...', reasonOnly:false };
    if(type === 'refuse') return { title:'–û–¢–ö–ê–ó', save:'–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∫–∞–∑', placeholder:'–£–∫–∞–∂–∏ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞...', reasonOnly:true };
    return { title:'–ù–î–ó (–í–µ—Ä–Ω—É—Ç—å)', save:'–í–µ—Ä–Ω—É—Ç—å', placeholder:'–£–∫–∞–∂–∏ –ø—Ä–∏—á–∏–Ω—É –≤–æ–∑–≤—Ä–∞—Ç–∞...', reasonOnly:true };
}

function openTechActionModal(state){
    techActionModalState = state || null;
    const box = document.getElementById('techActionModal');
    const title = document.getElementById('techActionModalTitle');
    const hint = document.getElementById('techActionModalHint');
    const opWrap = document.getElementById('techActionOperatorWrap');
    const opInfo = document.getElementById('techActionOperatorInfo');
    const ta = document.getElementById('techActionModalText');
    const saveBtn = document.getElementById('techActionModalSave');

    const ui = getTechActionUi((state || {}).type || 'return');
    if(title) title.textContent = `üõ† ${ui.title}`;
    if(hint) hint.textContent = ui.reasonOnly
      ? '–¢–æ–ª—å–∫–æ –ø—Ä–∏—á–∏–Ω–∞ –æ—Ç —Ç–µ—Ö–Ω–∏–∫–∞. –û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è.'
      : '–ü—Ä–æ–≤–µ—Ä—å –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –∏–Ω—Ñ–æ –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π –Ω–∞ –∑–∞–∫—Ä—ã–≤.';

    if(opWrap) opWrap.style.display = ui.reasonOnly ? 'none' : 'block';
    if(opInfo) opInfo.textContent = (state && state.operatorInfo) ? state.operatorInfo : '-';
    if(ta){
      ta.value = (state && state.initialText) ? state.initialText : '';
      ta.placeholder = ui.placeholder;
    }
    if(saveBtn) saveBtn.textContent = ui.save;

    if(box) box.classList.remove('hidden');
}

function closeTechActionModal(){
    techActionModalState = null;
    const box = document.getElementById('techActionModal');
    if(box) box.classList.add('hidden');
}

function openTechOrderActionModal(id, type){
    const o = findOrderInCacheById(id);
    const operatorInfo = (o && (o.details || o.operatorComment)) ? (o.details || o.operatorComment) : '';
    const initialText = type === 'closer' ? operatorInfo : '';
    openTechActionModal({ scope:'order', id, type, operatorInfo, initialText });
}

function openTechCallbackActionModal(callbackId, type){
    const arr = window._callbacksCache || [];
    const item = arr.find(x => x && String(x.id) === String(callbackId));
    if(!item) return alert('–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
    const operatorInfo = (item.card && (item.card.details || item.card.operatorComment)) || item.text || '';
    const initialText = type === 'closer' ? operatorInfo : '';
    openTechActionModal({ scope:'callback', callbackId, sourceId: item.sourceId, type, operatorInfo, initialText });
}

async function saveTechActionModal(){
    const state = techActionModalState;
    const ta = document.getElementById('techActionModalText');
    const saveBtn = document.getElementById('techActionModalSave');
    if(!state) return alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏—è.');
    const info = (ta ? ta.value : '').trim();
    if(!info) return alert('–ó–∞–ø–æ–ª–Ω–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.');

    const status = (state.type === 'return') ? 'return' : (state.type === 'refuse' ? 'refuse' : 'closer');

    if(state.scope === 'order'){
      const r = await fetch('/api/orders/action', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: state.id, status, info, techLogin: me.login })
      });
      const d = await r.json().catch(()=>({}));
      if(!r.ok || d.success === false) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É: ' + (d.error || r.status));
      closeTechActionModal();
      await Promise.all([loadOrders('tech'), loadOrders('tech-my'), loadOrders('returns')]);
      return;
    }

    if(state.scope === 'callback'){
      if(!state.sourceId) return alert('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∏—Å—Ö–æ–¥–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.');
      const r1 = await fetch('/api/orders/action', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: state.sourceId, status, info, techLogin: me.login })
      });
      const d1 = await r1.json().catch(()=>({}));
      if(!r1.ok || d1.success === false) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É: ' + (d1.error || r1.status));

      const r2 = await fetch('/api/callbacks/delete', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ login: me.login, id: state.callbackId })
      });
      const d2 = await r2.json().catch(()=>({}));
      if(!r2.ok || d2.success === false) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑ –ø–µ—Ä–µ–∑–≤–æ–Ω–∞: ' + (d2.error || r2.status));

      closeTechActionModal();
      await Promise.all([loadCallbacks(), loadOrders('tech-my'), loadOrders('returns')]);
    }
}

async function orderAction(id, type) {
    openTechOrderActionModal(id, type);
}

async function techTakeInWork(id) {
    const r = await fetch('/api/orders/action', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, status: 'tech_work', info: '–í–∑—è–ª –≤ —Ä–∞–±–æ—Ç—É', techLogin: me.login })
    });
    const d = await r.json().catch(()=>({}));
    if(!r.ok || d.success === false) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É: ' + (d.error || r.status));
    await Promise.all([loadOrders('tech'), loadOrders('tech-my')]);
    await openTab('tech-my');
}

async function moveTechToCallback(id){
    const arr = (ordersCache['tech'] || []).concat(ordersCache['tech-my'] || []);
    let o = arr.find(x => String(x.id) === String(id));
    if(!o){
        const r = await fetch(`/api/orders?login=${encodeURIComponent(me.login)}&role=${encodeURIComponent(me.role)}&view=tech`);
        const rows = await r.json().catch(()=>[]);
        o = (Array.isArray(rows)?rows:[]).find(x => String(x.id) === String(id));
    }
    if(!o) return alert('–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–∏ –≤–∫–ª–∞–¥–∫—É.');

    const r1 = await fetch('/api/orders/action', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id: o.id, status: 'tech_callback', info: '–ü–µ—Ä–µ–∑–≤–æ–Ω', techLogin: me.login })
    });
    if(!r1.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–º–µ—Ç–∏—Ç—å –Ω–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω');

    const r2 = await fetchCallbacksApi('/api/callbacks/add', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        login: me.login,
        role: me.role,
        source: 'tech',
        sourceId: o.id,
        clientName: o.clientName || '',
        phone: o.phone || '',
        text: o.details || o.techInfo || o.operatorComment || '',
        card: {
          status: o.status || '',
          operator: o.operator || '',
          tech: o.tech || '',
          closer: o.closer || '',
          details: o.details || '',
          techInfo: o.techInfo || '',
          operatorComment: o.operatorComment || '',
          finalText: o.finalText || '',
          finalColor: o.finalColor || ''
        }
      })
    });
    const d2 = await r2.json().catch(()=>({}));
    if(!r2.ok || !d2.success) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–∑–≤–æ–Ω: ' + (d2.error || r2.status));

    await Promise.all([loadOrders('tech'), loadOrders('tech-my'), loadCallbacks()]);
}

async function returnToTech(id) {
    let c = prompt("–û—Ç–≤–µ—Ç –¥–ª—è —Ç–µ—Ö–Ω–∏–∫–∞:");
    await fetch('/api/orders/to-tech', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, comment: c })
    });
    loadOrders('returns');
}

async function finalOrder(id) {
    let t = prompt("–ò—Ç–æ–≥ —Å–¥–µ–ª–∫–∏:");
    let c = prompt("–¶–≤–µ—Ç (green, red, yellow)?", "green");
    if(t) {
        await fetch('/api/orders/final', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ id, text: t, color: c, closerLogin: me.login })
        });
        loadOrders('closer');
    }
}

async function kupatAction(id, status) {
    let note = prompt("–ó–∞–º–µ—Ç–∫–∞:");
    await fetch('/api/kupat/action', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, status, note, user: me.login })
    });
    await Promise.all([loadKupat(), loadKupatMyClients(), loadKupatMyTransfers()]);
}

async function kupatTakeInWork(id, selectId) {
    const assignee = document.getElementById(selectId)?.value || me.login;
    await fetch('/api/kupat/action', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, status: 'kupat_work', user: assignee, note: '–í–∑—è–ª –≤ —Ä–∞–±–æ—Ç—É' })
    });
    await Promise.all([loadKupat(), loadKupatMyClients(), loadKupatMyTransfers()]);
}

async function kupatTakeRefuse(id, selectId) {
    const assignee = document.getElementById(selectId)?.value || me.login;
    let note = prompt("–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞:");
    await fetch('/api/kupat/action', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, status: 'kupat_refuse', user: assignee, note: note || '–û—Ç–∫–∞–∑' })
    });
    await Promise.all([loadKupat(), loadKupatMyClients(), loadKupatMyTransfers()]);
}

async function kupatAssignCloser(id, selectId) {
    const closer = document.getElementById(selectId)?.value || me.login;
    const r = await fetch('/api/kupat/assign-closer', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ id, closer, requesterRole: me.role })
    });
    if(!r.ok){
        const t = await r.text();
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –∑–∞–∫—Ä—ã–≤–∞: ' + t);
        return;
    }
    await Promise.all([loadKupat(), loadKupatMyTransfers()]);
}

async function saveKupatComment(id, textareaId){
    const el = document.getElementById(textareaId);
    if(!el) return;
    const text = (el.value || '').trim();
    const fileEl = document.getElementById(textareaId + '_file');
    const file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;
    if(!text && !file) return alert('–ü—É—Å—Ç–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.');

    const fd = new FormData();
    fd.append('id', id);
    fd.append('login', me.login);
    fd.append('role', me.role);
    fd.append('text', text);
    if(file) fd.append('file', file);

    const r = await fetch('/api/kupat/comment', {
        method:'POST',
        body: fd
    });
    const d = await r.json().catch(() => ({}));
    if(!r.ok || !d.success){
        return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ' + (d.error || r.status));
    }

    el.value = '';
    if(fileEl) fileEl.value = '';
    await Promise.all([loadKupatMyClients(), loadKupatMyTransfers(), loadKupat()]);
}

async function kupatFinal(id) {
    let t = prompt("–ò—Ç–æ–≥ —Å–¥–µ–ª–∫–∏:");
    let c = prompt("–¶–≤–µ—Ç?", "green");
    if(t) {
        await fetch('/api/kupat/final', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ id, text: t, color: c, closer: me.login })
        });
        await Promise.all([loadKupat(), loadKupatMyClients(), loadKupatMyTransfers()]);
    }
}

async function delItem(id, type) {
    if(confirm("–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞?")) {
        await fetch('/api/delete-item', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ id, type })
        });
        type === 'orders' ? loadOrders('tech') : loadKupat();
    }
}

// --- ADMIN & DB ---
async function loadLogs() {
    const r = await fetch('/api/call-logs?role=admin');
    const d = await r.json();
    document.querySelector('#table-logs tbody').innerHTML = d.reverse().slice(0,100).map(l => `
        <tr>
            <td>${l.time}</td><td><b>${l.user}</b></td><td>${l.phone}</td>
            <td><span class="badge">${l.status}</span></td><td>${(l.note||'').substring(0,30)}...</td>
        </tr>
    `).join('');
}

async function loadStats() {
    const r = await fetch('/api/stats');
    const d = await r.json();
    const list = d.byUsers || [];
    // –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–∞–¥–º–∏–Ω–∫–∞)
    document.getElementById('table-stats').innerHTML =
        `<tr>
            <th>–õ–æ–≥–∏–Ω</th>
            <th>–†–æ–ª—å</th>
            <th>–ë–∞–ª–∞–Ω—Å</th>
            <th>–¢—Ä—É–±–æ–∫</th>
            <th>–ü–µ—Ä–µ–¥–∞–ª</th>
            <th>–ù–∞ –ö—É–ø–∞—Ç</th>
            <th>X</th>
        </tr>` +
        list.map(u => {
            const c = u.calls || {};
            return `
            <tr>
                <td>${escapeHtml(u.login)}</td>
                <td>${escapeHtml(roleTitle(u.role))}</td>
                <td>${Number(u.balance || 0)}</td>
                <td>${Number(c.total || 0)}</td>
                <td>${Number(c.passedToTech || 0)}</td>
                <td>${Number(c.sentToKupat || 0)}</td>
                <td><button onclick="delUser('${String(u.login).replace(/'/g, "\\'")}')" class="btn-red" style="padding:2px 5px">X</button></td>
            </tr>`;
        }).join('');

    // –°–µ–ª–µ–∫—Ç –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞
    const sel = document.getElementById('balUser');
    if (sel) {
        sel.innerHTML = list.map(u => `<option value="${escapeHtml(u.login)}">${escapeHtml(u.login)} (${escapeHtml(roleTitle(u.role))})</option>`).join('');
    }
}

async function uploadDb() {
    const fd = new FormData();
    fd.append('file', document.getElementById('fileIn').files[0]);
    await fetch('/api/upload', {method:'POST', body:fd});
    loadDbs();
}

async function loadDbs() {
    const r = await fetch('/api/databases');
    const d = await r.json();
    dbListCache = Array.isArray(d) ? d : [];
    document.getElementById('dbSel').innerHTML = dbListCache.map(db => `<option value="${db.id}">${db.name}${db.allowDuplicates ? ' (–ø–æ–≤—Ç–æ—Ä—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã)' : ''}</option>`).join('');
    syncDbAllowDupToggle();
}

function syncDbAllowDupToggle(){
    const sel = document.getElementById('dbSel');
    const cb = document.getElementById('dbAllowDup');
    if(!sel || !cb) return;
    const current = dbListCache.find(db => String(db.id) === String(sel.value));
    cb.checked = !!(current && current.allowDuplicates);
}

async function activateDb() {
    const dbId = document.getElementById('dbSel').value;
    const allowDuplicates = !!document.getElementById('dbAllowDup')?.checked;
    await fetch('/api/set-active-db', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ dbId, allowDuplicates })
    });
    alert(allowDuplicates ? "–ë–∞–∑–∞ –≤—ã–±—Ä–∞–Ω–∞! –ü–æ–≤—Ç–æ—Ä—ã –¥–ª—è —ç—Ç–æ–π –±–∞–∑—ã —Ä–∞–∑—Ä–µ—à–µ–Ω—ã." : "–ë–∞–∑–∞ –≤—ã–±—Ä–∞–Ω–∞!");
    await loadDbs();
}

async function addUser() {
    await fetch('/api/users/add', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ 
            login: document.getElementById('nL').value, 
            pass: document.getElementById('nP').value, 
            role: document.getElementById('nR').value, balance: 0 })
    });
    loadStats();
}

async function delUser(login) {
    if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞?")) {
        await fetch('/api/users/delete', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({login, requesterRole: me?.role})
        });
        loadStats();
    }
}

// INCOME (admin) ‚Äî salary calculator
function _n(v) {
    const x = parseFloat(String(v).replace(',', '.'));
    return isFinite(x) ? x : 0;
}
function _fmt(x) {
    // keep .5 etc, but trim trailing zeros
    const s = (Math.round((x + Number.EPSILON) * 100) / 100).toString();
    return s.includes('.') ? s.replace(/0+$/,'').replace(/\.$/,'') : s;
}
function incomeCalc() {
    if(!me || me.role !== 'admin') return;

    const sum = _n(document.getElementById('inc_sum')?.value);
    const kuraPct = _n(document.getElementById('inc_kura')?.value);
    const clientPct = _n(document.getElementById('inc_client_pct')?.value);
    const divBy = Math.max(_n(document.getElementById('inc_div')?.value), 0);
    const mulBy = _n(document.getElementById('inc_mul')?.value);

    const kuraSum = sum * (kuraPct/100);
    const afterKura = sum - kuraSum;

    // IMPORTANT: –ø–æ —Ç–≤–æ–µ–º—É –ø—Ä–∏–º–µ—Ä—É "–∏—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞" ‚Äî —ç—Ç–æ % –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞ –û–¢ –æ—Å—Ç–∞—Ç–∫–∞ (–Ω–µ –æ—Å—Ç–∞—Ç–æ–∫ + %)
    const clientSum = afterKura * (clientPct/100);

    const afterDiv = divBy > 0 ? (clientSum / divBy) : 0;
    const total = afterDiv * mulBy;

    const set = (id,val) => { const el=document.getElementById(id); if(el) el.textContent = val; };

    set('inc_kura_sum', `${_fmt(kuraPct)}% = ${_fmt(kuraSum)}`);
    set('inc_after_kura', _fmt(afterKura));
    set('inc_client_pct_out', `${_fmt(clientPct)}%`);
    set('inc_client_sum', _fmt(clientSum));
    set('inc_div_res', divBy>0 ? `${_fmt(clientSum)} / ${_fmt(divBy)} = ${_fmt(afterDiv)}` : '‚Äî');
    set('inc_total', `${_fmt(afterDiv)} √ó ${_fmt(mulBy)} = ${_fmt(total)}`);
}

function incomeReset() {
    if(!me || me.role !== 'admin') return;
    document.getElementById('inc_sum').value = 10000;
    document.getElementById('inc_kura').value = 14;
    document.getElementById('inc_client_pct').value = 15;
    document.getElementById('inc_div').value = 4;
    document.getElementById('inc_mul').value = 36;
    incomeCalc();
}

function wireIncomeInputs() {
    const ids = ['inc_sum','inc_kura','inc_client_pct','inc_div','inc_mul'];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if(el) el.addEventListener('input', incomeCalc);
    });
}


async function loadMyStats(){
    if(!me) return;
    // ensure container exists
    let box = document.getElementById('myStatsBox');
    if(!box){    }
    if(box) box.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
    try{
        const r = await fetch(`/api/me-stats?login=${encodeURIComponent(me.login)}&role=${encodeURIComponent(me.role)}`, {cache:'no-store'});
        if(!r.ok){
            const t = await r.text().catch(()=> '');
            throw new Error(`HTTP ${r.status} ${t}`);
        }
        const data = await r.json();
        const bal = (data.balance ?? 0);
        const s = data.stats || {};
        const lines = [];
        // –ë–∞–ª–∞–Ω—Å –æ—Ç–¥–µ–ª—å–Ω–æ
        lines.push(`<div style="display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap">
            <div>
                <div class="muted" style="font-size:12px">–í–∞—à –±–∞–ª–∞–Ω—Å</div>
                <div style="font-size:28px; font-weight:800">${Number(bal).toLocaleString('ru-RU')}</div>
            </div>
            <div class="muted" style="font-size:12px">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${escapeHtml(formatUTC2(new Date().toISOString()))}</div>
        </div>`);

        // –ö–Ω–æ–ø–∫–∏ –æ–±–∑–≤–æ–Ω–∞
        const calls = data.calls || {};
        lines.push(`<hr style="border:0; border-top:1px solid #333; margin:12px 0">`);
        lines.push(`<div style="font-weight:800; margin-bottom:6px">üìû –û–±–∑–≤–æ–Ω (–Ω–∞–∂–∞—Ç—ã–µ –∫–Ω–æ–ø–∫–∏)</div>`);
        lines.push(`<div class="grid2">
            <div class="mini">–í—Å–µ–≥–æ –Ω–∞–∂–∞—Ç–∏–π: <b>${calls.total ?? 0}</b></div>
            <div class="mini">–ü–µ—Ä–µ–¥–∞–ª (—Ç—Ä—É–±–∫–∞): <b>${calls.passedToTech ?? 0}</b></div>
            <div class="mini">–ù–∞ –ö—É–ø–∞—Ç: <b>${calls.sentToKupat ?? 0}</b></div>
            <div class="mini"></div>
        </div>`);

        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º —É –∑–∞–∫—Ä—ã–≤–∞
        const cl = data.closer || {};
        lines.push(`<hr style="border:0; border-top:1px solid #333; margin:12px 0">`);
        if(me.role === 'user'){
            lines.push(`<div style="font-weight:800; margin-bottom:6px">üí∞ –ú–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã —É –∑–∞–∫—Ä—ã–≤–∞</div>`);
            lines.push(`<div class="grid2">
                <div class="mini">–ö–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–ø–∞–ª–æ –∫ –∑–∞–∫—Ä—ã–≤—É: <b>${cl.operatorToCloser ?? 0}</b></div>
                <div class="mini">–£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç–∏–π (final): <b>${cl.operatorFinalByCloser ?? 0}</b></div>
            </div>`);
        } else if(me.role === 'closer'){
            lines.push(`<div style="font-weight:800; margin-bottom:6px">üíº –ú–æ—è —Ä–∞–±–æ—Ç–∞ (–∑–∞–∫—Ä—ã–≤)</div>`);
            lines.push(`<div class="grid2">
                <div class="mini">–ö–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Ä–∞–±–æ—Ç–µ/–∏—Å—Ç–æ—Ä–∏–∏: <b>${cl.closerWorked ?? 0}</b></div>
                <div class="mini">–£—Å–ø–µ—à–Ω—ã—Ö (final): <b>${cl.closerFinal ?? 0}</b></div>
            </div>`);
        } else {
            // –¥–ª—è —Ç–µ—Ö–Ω–∏–∫/–∫—É–ø–∞—Ç: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –æ–±—â—É—é –ø–∞—Ä—É, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –¥–∞–ª
            lines.push(`<div style="font-weight:800; margin-bottom:6px">üí∞ –ö–ª–∏–µ–Ω—Ç—ã —É –∑–∞–∫—Ä—ã–≤–∞</div>`);
            lines.push(`<div class="grid2">
                <div class="mini">–ö–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–ø–∞–ª–æ –∫ –∑–∞–∫—Ä—ã–≤—É (–ø–æ –≤–∞—à–∏–º): <b>${cl.operatorToCloser ?? 0}</b></div>
                <div class="mini">–£—Å–ø–µ—à–Ω—ã—Ö (final): <b>${cl.operatorFinalByCloser ?? 0}</b></div>
            </div>`);
        }

        // –î–æ–ø: –∑–∞—è–≤–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if(s.main){
            lines.push(`<hr style="border:0; border-top:1px solid #333; margin:12px 0">`);
            lines.push(`<div style="font-weight:800; margin-bottom:6px">üìã –û—Å–Ω–æ–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏</div>`);
            lines.push(`<div class="grid2">
                <div class="mini">–í—Å–µ–≥–æ: <b>${Number(s.main.total||0)}</b></div>
                <div class="mini">–ù–æ–≤—ã–µ/–¥–æ—Ä–∞–±–æ—Ç–∫–∞/–≤–æ–∑–≤—Ä–∞—Ç: <b>${Number(s.main.new||0)}</b></div>
                <div class="mini">–ù–∞ –∑–∞–∫—Ä—ã–≤–∞: <b>${Number(s.main.closer||0)}</b></div>
                <div class="mini">–§–∏–Ω–∞–ª: <b>${Number(s.main.final||0)}</b></div>
            </div>`);
        }

        if(s.kupat){
            lines.push(`<hr style="border:0; border-top:1px solid #333; margin:12px 0">`);
            lines.push(`<div style="font-weight:800; margin-bottom:6px">üë¥ –ü–æ—Ç–æ–∫ –ö—É–ø–∞—Ç</div>`);
            lines.push(`<div class="grid2">
                <div class="mini">–í—Å–µ–≥–æ: <b>${Number(s.kupat.total||0)}</b></div>
                <div class="mini">–í—Ö–æ–¥—è—â–∏–µ: <b>${Number(s.kupat.incoming||0)}</b></div>
                <div class="mini">–ö —Ñ–∏–Ω–∞–ª—É: <b>${Number(s.kupat.final||0)}</b></div>
                <div class="mini"></div>
            </div>`);
        }

        // –ê–¥–º–∏–Ω—É ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –ø–æ –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
        if(me.role === 'admin'){
            const rr = await fetch('/api/stats', {cache:'no-store'});
            const all = await rr.json();
            const rows = (all.byUsers || []).map(u=>{
                const c = u.calls || {};
                const m = u.main || {};
                const k = u.kupat || {};
                return `<tr>
                    <td><b>${escapeHtml(u.login)}</b><div class="muted" style="font-size:12px">${escapeHtml(roleTitle(u.role))}</div></td>
                    <td class="right"><b>${Number(u.balance||0)}</b></td>
                    <td class="right">${Number(c.total||0)}</td>
                    <td class="right">${Number(c.passedToTech||0)}</td>
                    <td class="right">${Number(c.sentToKupat||0)}</td>
                    <td class="right">${Number(m.created||0)}</td>
                    <td class="right">${Number(m.techTook||0)}</td>
                    <td class="right">${Number(m.closerFinal||0)}</td>
                    <td class="right">${Number(k.fromOperator||0)}</td>
                    <td class="right">${Number(k.kupatToCloser||0)}</td>
                    <td class="right">${Number(k.kupatFinalByCloser||0)}</td>
                </tr>`;
            }).join('');

            lines.push(`<hr style="border:0; border-top:1px solid #333; margin:12px 0">`);
            lines.push(`<div style="font-weight:800; margin-bottom:8px">üë• –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>`);
            lines.push(`<div class="tableWrap">
                <table class="tbl">
                    <thead>
                        <tr>
                            <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                            <th class="right">–ë–∞–ª–∞–Ω—Å</th>
                            <th class="right">–¢—Ä—É–±–æ–∫</th>
                            <th class="right">–ü–µ—Ä–µ–¥–∞–ª</th>
                            <th class="right">–ù–∞ –ö—É–ø–∞—Ç</th>
                            <th class="right">–°–æ–∑–¥–∞–ª –∑–∞—è–≤–æ–∫</th>
                            <th class="right">–í–∑—è–ª –∫–∞–∫ —Ç–µ—Ö</th>
                            <th class="right">–§–∏–Ω–∞–ª –∫–∞–∫ –∑–∞–∫—Ä—ã–≤</th>
                            <th class="right">–û—Ç –æ–ø–µ—Ä (–ö—É–ø–∞—Ç)</th>
                            <th class="right">–ö—É–ø–∞—Ç‚Üí–ó–∞–∫—Ä—ã–≤</th>
                            <th class="right">–ö—É–ø–∞—Ç —Ñ–∏–Ω–∞–ª</th>
                        </tr>
                    </thead>
                    <tbody>${rows || `<tr><td colspan="11" class="muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`}</tbody>
                </table>
            </div>`);
        }

        if(box) box.innerHTML = lines.join('');
    }catch(e){
        if(box) box.innerHTML = `<div style="color:#ff7b72; font-weight:700">–û—à–∏–±–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</div>
        <div class="muted" style="margin-top:6px; white-space:pre-wrap">${escapeHtml(e && e.message ? e.message : e)}</div>`;
    }
}


async function refreshUsersForAdmin(){
    if(!me || me.role!=='admin') return;
    try{
        const r = await fetch('/api/users');
        const data = await r.json();
        const sel = document.getElementById('balUser');
        if(!sel) return;
        sel.innerHTML = data.users.map(u=>`<option value="${escapeHtml(u.login)}">${escapeHtml(u.login)} (${escapeHtml(u.role)})</option>`).join('');
    }catch(e){}
}

async function setBalance(){
    if(!me || me.role!=='admin') return;
    const login = document.getElementById('balUser').value;
    const balance = Number(document.getElementById('balVal').value || 0);
    await fetch('/api/admin/set-balance', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ login, balance, requesterRole: me.role })
    });
    await await loadMyStats();
}

// Ensure login handler works even if inline handlers are blocked
document.addEventListener('DOMContentLoaded', () => {
    const dbSel = document.getElementById('dbSel');
    if(dbSel) dbSel.addEventListener('change', syncDbAllowDupToggle);

    const btn = document.getElementById('btnLogin');
    if (btn) btn.addEventListener('click', (e) => { e.preventDefault(); login(); });
    const pass = document.getElementById('pasIn');
    if (pass) pass.addEventListener('keydown', (e) => { if (e.key === 'Enter') login(); });
});
// expose for any remaining inline usage
window.login = login;





/* ===== –ó–∞–º–µ—Ç–∫–∏ (–ª–∏—á–Ω—ã–µ) ===== */
let notesModalPayload = null;

function openNotesModal(payload, hintText, initialComment){
  notesModalPayload = payload || null;
  const box = document.getElementById('notesModal');
  const hint = document.getElementById('notesModalHint');
  const ta = document.getElementById('notesModalText');
  const wrap = document.getElementById('notesModalFileWrap');
  const fileEl = document.getElementById('notesModalFile');

  if(hint) hint.textContent = hintText || '';
  if(ta) ta.value = (initialComment || '');
  if(fileEl) fileEl.value = '';

  const canFile = (me.role === 'tech' || me.role === 'closer' || me.role === 'admin');
  if(wrap) wrap.style.display = canFile ? 'block' : 'none';

  if(box) box.classList.remove('hidden');
}

function closeNotesModal(){
  notesModalPayload = null;
  const box = document.getElementById('notesModal');
  if(box) box.classList.add('hidden');
}

async function saveNotesModal(){
  const ta = document.getElementById('notesModalText');
  const comment = (ta ? ta.value : '').trim();
  if(!notesModalPayload) return alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–∫–∏.');

  const fileEl = document.getElementById('notesModalFile');
  const file = fileEl && fileEl.files && fileEl.files[0] ? fileEl.files[0] : null;

  if(!comment && !file) return alert('–ù–∞–ø–∏—à–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏–ª–∏ –ø—Ä–∏–∫—Ä–µ–ø–∏ —Ñ–∞–π–ª.');

  // EDIT mode if payload has id
  if(notesModalPayload.id){
    const fd = new FormData();
    fd.append('login', me.login);
    fd.append('role', me.role);
    fd.append('id', notesModalPayload.id);
    fd.append('comment', comment);
    if(file) fd.append('file', file);

    const r = await fetch('/api/notes/update', {
      method:'PUT',
      body: fd
    });
    if(!r.ok){
      const t = await r.text().catch(()=> '');
      return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É: ' + (t || r.status));
    }
    closeNotesModal();
    const tab = document.getElementById('tab-notes');
    if(tab && !tab.classList.contains('hidden')) await loadNotes();
    return;
  }

  const noteObj = {
    ...notesModalPayload,
    comment,
    createdAt: new Date().toISOString()
  };

  const fd = new FormData();
  fd.append('login', me.login);
  fd.append('role', me.role);
  fd.append('note', JSON.stringify(noteObj));
  if(file) fd.append('file', file);

  const r = await fetch('/api/notes/add', { method:'POST', body: fd });
  if(!r.ok){
    const t = await r.text().catch(()=> '');
    return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É: ' + (t || r.status));
  }
  closeNotesModal();
  const tab = document.getElementById('tab-notes');
  if(tab && !tab.classList.contains('hidden')) await loadNotes();
}


async function loadNotes(){
  const list = document.getElementById('notes-list');
  if(list) list.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  const r = await fetch('/api/notes?login=' + encodeURIComponent(me.login));
  if(!r.ok){
    if(list) list.innerHTML = '<div style="color:#ff7b72">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–º–µ—Ç–æ–∫</div>';
    return;
  }
  const data = await r.json();
  window._notesCache = Array.isArray(data) ? data : [];
  renderNotes(window._notesCache);
}

function renderNotes(items){
  const list = document.getElementById('notes-list');
  if(!list) return;
  if(!items.length){
    list.innerHTML = '<div class="muted">–ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.</div>';
    return;
  }
  list.innerHTML = items.slice().reverse().map(n => {
    const when = n.createdAt ? formatUTC2(n.createdAt) : '';
    return `
      <div class="order-item" style="border-color:#7c3aed;">
        <div class="order-grid">
          <div class="order-head">
            <div>
              <div class="order-title">${escapeHtml(n.clientName || '')}</div>
              <div class="order-phone">${escapeHtml(n.phone || '')} <span class="badge">–ó–∞–º–µ—Ç–∫–∏</span></div>
            </div>
            ${n.phone ? `<a href="sip:${escapeAttr(n.phone)}" class="sip-btn" onclick="trackEvent('CALL', '${escapeAttr(n.phone)}')">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>` : ''}
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="btn-pur" onclick="editNote('${escapeAttr(n.id)}')">‚úèÔ∏è</button>
              <button class="btn-red" onclick="deleteNote('${escapeAttr(n.id)}')">üóë</button>
            </div>
          </div>

          <div class="pillbar">
            <span class="pill"><small>–ê–≤—Ç–æ—Ä</small> <span class="who">${escapeHtml(n.owner || '')}</span></span>
            <span class="pill"><small>–ö–æ–≥–¥–∞</small> <span class="who">${escapeHtml(when)}</span></span>
          </div>

          ${n.text ? `<div class="kvcol"><div class="k">–¢–µ–∫—Å—Ç</div><div class="v">${escapeHtml(n.text)}</div></div>` : ''}
          ${n.file ? `<div class="kvcol"><div class="k">–§–∞–π–ª</div><div class="v">${renderMedia(n.file)}</div></div>` : ''}
          <div class="kvcol"><div class="k">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><div class="v">${escapeHtml(n.comment || '')}</div></div>
        </div>
      </div>
    `;
  }).join('');
}

// –û–ø–µ—Ä–∞—Ç–æ—Ä: —Ç–µ–∫—É—â–∏–π –∫–ª–∏–µ–Ω—Ç –æ–±–∑–≤–æ–Ω–∞ -> –∑–∞–º–µ—Ç–∫–∏
function addCurrentToNotes(){
  const c = window.curClient || null;
  if(!c || !c.phone) return alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ "–ù–ê–ß–ê–¢–¨ –û–ë–ó–í–û–ù".');
  const noteEl = document.getElementById('note');
  const baseText = (noteEl ? noteEl.value : '').trim();
  const payload = {
    source: 'dial',
    clientName: c.name || '',
    phone: c.phone || '',
    text: baseText
  };
  openNotesModal(payload, `–ö–ª–∏–µ–Ω—Ç: ${c.name || ''} ¬∑ ${c.phone || ''}`);
}

// –ó–∞–∫—Ä—ã–≤: –ª—é–±–∞—è –∑–∞—è–≤–∫–∞ (–¥—É–±–ª–∏—Ä—É–µ–º –≤ –∑–∞–º–µ—Ç–∫–∏, –Ω–µ —É–¥–∞–ª—è–µ–º)
const ordersCache = {};
async function addOrderToNotes(orderId, listType){
  const arr = ordersCache[listType] || [];
  const o = arr.find(x => String(x.id) === String(orderId));
  if(!o) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞—è–≤–∫—É –≤ —Å–ø–∏—Å–∫–µ.');
  const payload = {
    source: 'order',
    orderId: o.id,
    clientName: o.clientName || '',
    phone: o.phone || '',
    text: [
      o.details ? ('–ò–Ω—Ñ–æ: ' + o.details) : '',
      o.techInfo ? ('–¢–µ—Ö –∏–Ω—Ñ–æ: ' + o.techInfo) : '',
      o.operatorComment ? ('–û–ø–µ—Ä –∏–Ω—Ñ–æ: ' + o.operatorComment) : ''
    ].filter(Boolean).join('\n')
  };
  openNotesModal(payload, `–ó–∞—è–≤–∫–∞ #${o.id} ¬∑ ${o.clientName || ''} ¬∑ ${o.phone || ''}`);
}

function editNote(id){
  // find note in last loaded notes cache if exists in window._notesCache
  const items = window._notesCache || [];
  const n = items.find(x => x && String(x.id) === String(id));
  if(!n) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∑–∞–º–µ—Ç–∫—É.');
  const payload = { ...n, id: n.id };
  openNotesModal(payload, `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${n.clientName || ''} ¬∑ ${n.phone || ''}`, n.comment || '');
}

async function deleteNote(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É?')) return;
  const r = await fetch('/api/notes/delete', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ login: me.login, id })
  });
  if(!r.ok){
    const t = await r.text().catch(()=> '');
    return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ' + (t || r.status));
  }
  await loadNotes();
}


async function fetchCallbacksApi(path, opts){
  let r = await fetch(path, opts);
  if(r && r.status === 404){
    const alt = path
      .replace('/api/callbacks/', '/api/callback/')
      .replace('/api/callbacks?', '/api/callback?');
    if(alt !== path) r = await fetch(alt, opts);
  }
  return r;
}

async function addCurrentToCallbacks(){
  const c = window.curClient || null;
  if(!c || !c.phone) return alert('–°–Ω–∞—á–∞–ª–∞ –Ω–∞–∂–º–∏ "–ù–ê–ß–ê–¢–¨ –û–ë–ó–í–û–ù".');
  const noteEl = document.getElementById('note');
  const text = (noteEl ? noteEl.value : '').trim();
  const r = await fetch('/api/callbacks/add', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ login: me.login, role: me.role, source:'dial', clientName: c.name || '', phone: c.phone || '', text })
  });
  const d = await r.json().catch(()=>({}));
  if(!r.ok || !d.success) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–∑–≤–æ–Ω: ' + (d.error || r.status));
  alert('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–µ—Ä–µ–∑–≤–æ–Ω');
}

async function moveKupatToCallback(id){
  const arr = window._kupatMyClientsCache || [];
  let o = arr.find(x => String(x.id) === String(id));

  if(!o){
    const rList = await fetch(`/api/kupat/list?login=${encodeURIComponent(me.login)}&role=${encodeURIComponent(me.role)}&view=all`);
    const list = await rList.json().catch(() => []);
    o = (Array.isArray(list) ? list : []).find(x => String(x.id) === String(id));
  }
  if(!o) return alert('–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –û–±–Ω–æ–≤–∏ –≤–∫–ª–∞–¥–∫—É.');

  const r1 = await fetch('/api/kupat/action', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ id: o.id, status: 'kupat_callback', note: '–ü–µ—Ä–µ–∑–≤–æ–Ω', user: me.login })
  });
  if(!r1.ok) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–º–µ—Ç–∏—Ç—å –Ω–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω');

  const r2 = await fetchCallbacksApi('/api/callbacks/add', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ login: me.login, role: me.role, source:'kupat', sourceId: o.id, clientName: o.clientName || '', phone: o.phone || '', text: o.details || '' })
  });
  const d2 = await r2.json().catch(()=>({}));
  if(!r2.ok || !d2.success) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤ –ø–µ—Ä–µ–∑–≤–æ–Ω: ' + (d2.error || r2.status));

  await Promise.all([loadKupatMyClients(), loadCallbacks()]);
}

async function loadCallbacks(){
  const el = document.getElementById('list-callbacks');
  if(!el) return;
  el.innerHTML = '<div class="badge">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  const r = await fetch('/api/callbacks?login=' + encodeURIComponent(me.login));
  const data = await r.json().catch(() => []);
  const rows = Array.isArray(data) ? data : [];
  if(!rows.length){ el.innerHTML = '<div class="muted">–°–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–∑–≤–æ–Ω–∞ –ø—É—Å—Ç.</div>'; return; }

  const canToTech = me.role === 'user' || me.role === 'admin';
  const canToCloser = me.role === 'kupat' || me.role === 'admin';
  const canTechCallbackActions = me.role === 'tech' || me.role === 'admin';
  const canOperatorCallbackActions = me.role === 'user' || me.role === 'admin';

  el.innerHTML = rows.slice().reverse().map(c => {
    const techActions = canTechCallbackActions
      ? `<button class="btn-yel" onclick="openTechCallbackActionModal('${escapeAttr(c.id)}','return')">–ù–î–ó (–í–µ—Ä–Ω—É—Ç—å)</button>
         <button class="btn-red" onclick="openTechCallbackActionModal('${escapeAttr(c.id)}','refuse')">–û–¢–ö–ê–ó</button>
         <button class="btn-pur" onclick="openTechCallbackActionModal('${escapeAttr(c.id)}','closer')">–ù–ê –ó–ê–ö–†–´–í</button>
         <button class="btn-gray" onclick="loadCallbacks()">–ü–ï–†–ï–ó–í–û–ù</button>`
      : '';

    const operatorActions = canOperatorCallbackActions
      ? `<button class="btn-yel" onclick="callbackQuickResult('${escapeAttr(c.id)}','–ù–î–ó')">–ù–î–ó</button>
         <button class="btn-blue" onclick="callbackQuickResult('${escapeAttr(c.id)}','–ê–í–¢–û')">–ê–í–¢–û</button>
         <button class="btn-pur" onclick="callbackQuickResult('${escapeAttr(c.id)}','–ò–í–†–ò–¢')">–ò–í–†–ò–¢</button>
         <button class="btn-red" onclick="callbackQuickResult('${escapeAttr(c.id)}','–û–¢–ö–ê–ó')">–û–¢–ö–ê–ó</button>
         <button style="background:#e67e22" onclick="callbackQuickResult('${escapeAttr(c.id)}','–ù–ê –ö–£–ü–ê–¢')">–ù–ê –ö–£–ü–ê–¢</button>
         <button style="background:#238636" onclick="callbackQuickResult('${escapeAttr(c.id)}','–ü–ï–†–ï–î–ê–õ')">–ü–ï–†–ï–î–ê–õ</button>`
      : '';
	  
    return `
    <div class="order-item" style="border-left-color:#7c3aed;">
      <div class="order-head">
        <div>
          <div class="order-title">${escapeHtml(c.clientName || '–ë–µ–∑ –∏–º–µ–Ω–∏')}</div>
          <div class="order-phone">${escapeHtml(c.phone || '-')}</div>
        </div>
        <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
          ${c.phone ? `<a href="sip:${escapeAttr(c.phone)}" class="sip-btn" style="padding:8px 10px; font-size:13px; margin:0" onclick="trackEvent('CALL', '${escapeAttr(c.phone)}')">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>` : ''}
          <button class="btn-pur" onclick="editCallback('${escapeAttr(c.id)}')">‚úèÔ∏è</button>
          <button class="btn-red" onclick="deleteCallback('${escapeAttr(c.id)}')">üóë</button>
        </div>
      </div>
      <div class="pillbar" style="margin-top:8px">
        <span class="pill"><small>–ò—Å—Ç–æ—á–Ω–∏–∫</small><span class="who">${escapeHtml(c.source || '-')}</span></span>
        <span class="pill"><small>–í–ª–∞–¥–µ–ª–µ—Ü</small><span class="who">${escapeHtml(c.owner || '-')}</span></span>
        <span class="pill"><small>–ö–æ–≥–¥–∞</small><span class="who">${escapeHtml(formatUTC2(c.createdAt || c.time || ''))}</span></span>
      </div>
      <div class="kvcol" style="margin-top:8px"><div class="k">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div><div class="v">${escapeHtml(c.text || '')}</div></div>
      ${c.card ? `<div class="pillbar" style="margin-top:8px"><span class="pill"><small>–û–ø–µ—Ä</small><span class="who">${escapeHtml(c.card.operator || '-')}</span></span><span class="pill"><small>–¢–µ—Ö</small><span class="who">${escapeHtml(c.card.tech || '-')}</span></span><span class="pill"><small>–ó–∞–∫—Ä—ã–≤</small><span class="who">${escapeHtml(c.card.closer || '-')}</span></span><span class="pill"><small>–°—Ç–∞—Ç—É—Å</small><span class="who">${escapeHtml(c.card.status || '-')}</span></span></div><div class="kvcol" style="margin-top:8px"><div class="k">–ò–Ω—Ñ–æ –∫–∞—Ä—Ç–æ—á–∫–∏</div><div class="v">${escapeHtml([c.card.details, c.card.techInfo, c.card.operatorComment].filter(Boolean).join(' | ') || '-')}</div></div>${c.card.finalText ? `<div style="border:1px solid ${escapeAttr(c.card.finalColor || '#30363d')}; padding:8px; border-radius:10px; margin-top:8px">üèÅ ${escapeHtml(c.card.finalText)}</div>`:''}` : ''}
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        ${techActions}
        ${operatorActions}
        ${canToCloser ? `<button style="background:#238636" onclick="callbackToCloser('${escapeAttr(c.id)}')">–ü–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ –∑–∞–∫—Ä—ã–≤</button>` : ''}
        ${canToTech ? `<button class="btn-blue" onclick="callbackToTech('${escapeAttr(c.id)}')">–ü–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ —Ç–µ—Ö–Ω–∏–∫–∞</button>` : ''}
      </div>
    </div>
  `;
  }).join('');

  window._callbacksCache = rows;
}

async function editCallback(id){
  const arr = window._callbacksCache || [];
  const item = arr.find(x => x && String(x.id) === String(id));
  if(!item) return alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ.');
  const name = prompt('–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞:', item.clientName || '');
  if(name === null) return;
  const phone = prompt('–¢–µ–ª–µ—Ñ–æ–Ω:', item.phone || '');
  if(phone === null) return;
  const text = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:', item.text || '');
  if(text === null) return;
  const r = await fetch('/api/callbacks/update', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ login: me.login, id, clientName: name, phone, text }) });
  const d = await r.json().catch(()=>({}));
  if(!r.ok || !d.success) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å: ' + (d.error || r.status));
  await loadCallbacks();
}

async function deleteCallback(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –ø–µ—Ä–µ–∑–≤–æ–Ω–∞?')) return;
  const r = await fetch('/api/callbacks/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ login: me.login, id }) });
  const d = await r.json().catch(()=>({}));
  if(!r.ok || !d.success) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ' + (d.error || r.status));
  await loadCallbacks();
}

async function callbackToTech(id){
  const r = await fetch('/api/callbacks/transfer-tech', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ login: me.login, role: me.role, id }) });
  const d = await r.json().catch(()=>({}));
  if(!r.ok || !d.success) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–¥–∞—Ç—å —Ç–µ—Ö–Ω–∏–∫—É: ' + (d.error || r.status));
  await loadCallbacks();
}

async function callbackToCloser(id){
  const r = await fetch('/api/callbacks/transfer-closer', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ login: me.login, role: me.role, id }) });
  const d = await r.json().catch(()=>({}));
  if(!r.ok || !d.success) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–¥–∞—Ç—å –Ω–∞ –∑–∞–∫—Ä—ã–≤: ' + (d.error || r.status));
  await Promise.all([loadCallbacks(), loadKupat(), loadKupatMyTransfers()]);
}

async function deleteOrderAsTech(id){
  if(!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∫–ª–∏–µ–Ω—Ç–∞?')) return;
  const r = await fetch('/api/orders/delete-self', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ id, login: me.login, role: me.role })
  });
  const d = await r.json().catch(()=>({}));
  if(!r.ok || !d.success) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: ' + (d.error || r.status));
  await Promise.all([loadOrders('tech'), loadOrders('tech-my')]);
}

async function callbackTechAction(id, action){
  const arr = window._callbacksCache || [];
  const item = arr.find(x => x && String(x.id) === String(id));
  if(!item) return alert('–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
  if(!item.sourceId) return alert('–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∏—Å—Ö–æ–¥–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞.');

  const info = (action === 'return') ? '–ù–î–ó (–í–æ–∑–≤—Ä–∞—Ç)' : (action === 'refuse' ? '–û—Ç–∫–∞–∑' : '–ü–µ—Ä–µ–¥–∞–Ω–æ –Ω–∞ –∑–∞–∫—Ä—ã–≤');
  const r1 = await fetch('/api/orders/action', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ id: item.sourceId, status: action, info, techLogin: me.login })
  });
  const d1 = await r1.json().catch(()=>({}));
  if(!r1.ok || d1.success === false) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É: ' + (d1.error || r1.status));

  const r2 = await fetch('/api/callbacks/delete', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ login: me.login, id })
  });
  const d2 = await r2.json().catch(()=>({}));
  if(!r2.ok || d2.success === false) return alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑ –ø–µ—Ä–µ–∑–≤–æ–Ω–∞: ' + (d2.error || r2.status));

  await Promise.all([loadCallbacks(), loadOrders('tech-my'), loadOrders('returns')]);
}

async function callbackQuickResult(id, status){
  const arr = window._callbacksCache || [];
  const item = arr.find(x => x && String(x.id) === String(id));
  if(!item) return alert('–ö–∞—Ä—Ç–æ—á–∫–∞ –ø–µ—Ä–µ–∑–≤–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
  const note = prompt('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:', item.text || '') || '';
  await fetch('/api/save-result', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ status, user: me.login, phone: item.phone || '', name: item.clientName || '', note })
  });
  await fetch('/api/callbacks/delete', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ login: me.login, id })
  });
  await loadCallbacks();
}


async function createOrderToTech(){
  const st = document.getElementById('co-status');
  const name = (document.getElementById('co-name')?.value || '').trim();
  const phone = (document.getElementById('co-phone')?.value || '').trim();
  const tz = (document.getElementById('co-tz')?.value || '').trim();
  const address = (document.getElementById('co-address')?.value || '').trim();
  const age = (document.getElementById('co-age')?.value || '').trim();
  const extra = (document.getElementById('co-extra')?.value || '').trim();

  if(st) { st.textContent=''; st.classList.remove('err'); }

  if(!phone){
    if(st){ st.textContent='–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä'; st.classList.add('err'); }
    return;
  }
  // –ó–∞—â–∏—Ç–∞: –∫—É–ø–∞—Ç –Ω–µ –º–æ–∂–µ—Ç
  if(me?.role === 'kupat'){
    if(st){ st.textContent='–†–æ–ª—å –ö—É–ø–∞—Ç –Ω–µ –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∑–∞—è–≤–∫–∏'; st.classList.add('err'); }
    return;
  }

  const details = `–ò–º—è: ${name}\n–ù–æ–º–µ—Ä: ${phone}\n\n–¢–ó: ${tz}\n–ê–¥—Ä–µ—Å: ${address}\n–í–æ–∑—Ä–∞—Å—Ç: ${age}\n\n–î–æ–ø.–ò–Ω—Ñ–∞:\n${extra}`.trim();

  try{
    if(st) st.textContent='–û—Ç–ø—Ä–∞–≤–∫–∞...';
    const r = await fetch('/api/orders/create-direct', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        login: me.login,
        role: me.role,
        clientName: name,
        phone,
        tz,
        address,
        age,
        extra,
        details
      })
    });
    const j = await r.json().catch(()=>({}));
    if(!r.ok || !j.success){
      const msg = j.error || '–û—à–∏–±–∫–∞';
      if(st){ st.textContent='–û—à–∏–±–∫–∞: '+msg; st.classList.add('err'); }
      return;
    }
    if(st){ st.textContent='–ì–æ—Ç–æ–≤–æ! –ó–∞—è–≤–∫–∞ –ø–µ—Ä–µ–¥–∞–Ω–∞ —Ç–µ—Ö–Ω–∏–∫—É.'; st.classList.remove('err'); }
    // –æ—á–∏—Å—Ç–∫–∞
    ['co-name','co-phone','co-tz','co-address','co-age','co-extra'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    // –æ–±–Ω–æ–≤–∏–º —Ç–µ—Ö–Ω–∏–∫—É, –µ—Å–ª–∏ –∞–¥–º–∏–Ω/—Ç–µ—Ö–Ω–∏–∫
    try{ if(me.role==='tech' || me.role==='admin'){ await loadTech(); } }catch(e){}
  }catch(e){
    if(st){ st.textContent='–û—à–∏–±–∫–∞ —Å–µ—Ç–∏'; st.classList.add('err'); }
  }
}

</script>

<!-- Tech action modal -->
<div id="techActionModal" class="modal hidden">
  <div class="modal-backdrop" onclick="closeTechActionModal()"></div>
  <div class="modal-card" style="max-width:640px;">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div style="font-weight:900;" id="techActionModalTitle">üõ† –î–µ–π—Å—Ç–≤–∏–µ</div>
      <button class="btn-gray" onclick="closeTechActionModal()">‚úï</button>
    </div>
    <div style="margin-top:10px; color:#8b949e; font-size:12px" id="techActionModalHint"></div>

    <div id="techActionOperatorWrap" class="kvcol" style="margin-top:10px; display:none;">
      <div class="k">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</div>
      <div class="v" id="techActionOperatorInfo"></div>
    </div>

    <textarea id="techActionModalText" style="width:100%; min-height:140px; margin-top:10px;" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>

    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
      <button class="btn-gray" onclick="closeTechActionModal()">–û—Ç–º–µ–Ω–∞</button>
      <button id="techActionModalSave" class="btn-pur" onclick="saveTechActionModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Notes modal -->
<div id="notesModal" class="modal hidden">
  <div class="modal-backdrop" onclick="closeNotesModal()"></div>
  <div class="modal-card">
    <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
      <div style="font-weight:900;">üìù –î–æ–±–∞–≤–∏—Ç—å –≤ –∑–∞–º–µ—Ç–∫–∏</div>
      <button class="btn-gray" onclick="closeNotesModal()">‚úï</button>
    </div>
    <div style="margin-top:10px; color:#8b949e; font-size:12px" id="notesModalHint"></div>
    <textarea id="notesModalText" style="width:100%; min-height:110px; margin-top:10px;" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
    <div id="notesModalFileWrap" style="margin-top:10px; display:none;">
      <input type="file" id="notesModalFile" accept="image/*,video/*" />
      <div class="muted" style="font-size:11px; margin-top:6px;">–§–∞–π–ª—ã –º–æ–≥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Ç–µ—Ö–Ω–∏–∫ –∏ –∑–∞–∫—Ä—ã–≤.</div>
    </div>
    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px;">
      <button class="btn-gray" onclick="closeNotesModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-pur" onclick="saveNotesModal()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

</body>
</html>